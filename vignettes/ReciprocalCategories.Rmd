---
title: "Reciprocal alignment comparisons"
author: 
 - "Michael Mansfield"
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Reciprocal alignment comparisons}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(cache = TRUE)
```

# Introduction

In this vignette we examine the differences in alignment categories between 

The core functions used here are maintained in our _GenomicBreaks_ R package,
which is fully documented at: <https://oist.github.io/GenomicBreaks>.

## Load packages

# Load R packages and data

```{r load_packages_and_data}
library("OikScrambling")   |> suppressPackageStartupMessages()
library("viridis")         |> suppressPackageStartupMessages()
library("dplyr")           |> suppressPackageStartupMessages()
library("GenomicFeatures") |> suppressPackageStartupMessages()
library("patchwork")       |> suppressPackageStartupMessages()
genomes     <- OikScrambling:::loadAllGenomes()
transcripts <- OikScrambling:::loadAllTranscriptsGR()
annots      <- OikScrambling:::loadAllAnnotations() |> suppressWarnings()
genes       <- sapply(annots, function(s) genes(s) |> sort()) |> SimpleList()
reps <- OikScrambling:::loadAllRepeats()
load("BreakPoints.Rdata")
```

# Reciprocal category fractions 
```{r category_fractions}
d_oki <- wgo$Oki_Osa |> as.data.frame() |> dplyr::select(type, width) |> dplyr::group_by(type) |> dplyr::summarise(width=sum(width)) |> dplyr::mutate(pct=round(width/sum(width)*100, 1), target='Okinawa', query='Osaka')
d_osa <- wgo$Osa_Oki |> as.data.frame() |> dplyr::select(type, width) |> dplyr::group_by(type) |> dplyr::summarise(width=sum(width)) |> dplyr::mutate(pct=round(width/sum(width)*100, 1), target='Osaka', query='Okinawa')


as.data.frame(d_oki)
as.data.frame(d_osa)

d_osa$width/d_oki$width*100

```

```{r category_fractions_2, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
genes_in_breakpoints <- SimpleList()
genes_in_breakpoints$Oki_Osa <- genes$Oki[subjectHits(findOverlaps(  genes$Oki, wgo$Oki_Osa[wgo$Oki_Osa$type %in% c("breakpoint region")], type='within')) |> unique() |> sort()]
genes_in_breakpoints$Oki_Bar <- genes$Oki[subjectHits(findOverlaps(  genes$Oki, wgo$Oki_Bar[wgo$Oki_Bar$type %in% c("breakpoint region")], type='within')) |> unique() |> sort()]
genes_in_breakpoints$Oki_Kum <- genes$Oki[subjectHits(findOverlaps(  genes$Oki, wgo$Oki_Kum[wgo$Oki_Kum$type %in% c("breakpoint region")], type='within')) |> unique() |> sort()]
genes_in_breakpoints$Osa_Bar <- genes$Osa[subjectHits(findOverlaps(  genes$Osa, wgo$Osa_Bar[wgo$Osa_Bar$type %in% c("breakpoint region")], type='within')) |> unique() |> sort()]


read_pho <- function (file, species = NULL) {
  pho <- read.delim(file, check.names = FALSE)
  pho <- pho[, sapply(pho, function(col) !all(is.na(col)))]
  if (!is.null(species))
    pho <- pho[, c("HOG", "OG", "Gene Tree Parent Clade", species)]
  nonempt <- do.call(cbind, lapply(pho, function(x) x != ""))
  un.rows <- apply(nonempt, 1, all)
  pho.un <- pho[un.rows, ]
  as(pho.un, "DataFrame")
}
pho <- read_pho(system.file("extdata/OrthoFinder/N19.tsv", package = "BreakpointsData"))

split_gene_id <- function(str, sep="\\.", field=3){
  unlist(strsplit(str, sep))[field]
}
  
replace_gene_ids <- function(str, sep="\\.", field=3){
  # For every row in an orthologue table...
  lapply(str, function(x){
    # If commas are in the row, lapply over the list and split them all
    if(grepl(",", x)){
      ids <- unlist(strsplit(x, ', '))
      return(CharacterList(lapply(ids, function(y) split_gene_id(y, sep=sep, field=field))))
    } else {
      return(split_gene_id(x, sep=sep, field=field))
    }
  }) |> unlist()
}

colnames(pho)[4:9] <- c('Aom', 'Bar', 'Kum', 'Oki', 'Osa', 'Nor')

pho$Aom <- replace_gene_ids(pho$Aom, field=2)
pho$Bar <- replace_gene_ids(pho$Bar, field=2)
pho$Kum <- replace_gene_ids(pho$Kum, field=2)
pho$Oki <- replace_gene_ids(pho$Oki, field=3)
pho$Osa <- replace_gene_ids(pho$Osa, field=3)
pho$Nor <- replace_gene_ids(pho$Nor, field=2)


pho$Aom_count <- unlist(lapply(pho$Aom, length))
pho$Bar_count <- unlist(lapply(pho$Bar, length))
pho$Kum_count <- unlist(lapply(pho$Kum, length))
pho$Oki_count <- unlist(lapply(pho$Oki, length))
pho$Osa_count <- unlist(lapply(pho$Osa, length))
pho$Nor_count <- unlist(lapply(pho$Nor, length))

annotate_orthogroups <- function(gr, og, sp){
  og_ids <- og[[sp]]
  bp_ids <- gr$gene_id
  check_in_og_list <- function(gene_id, og_list) {
    oml <- lapply(og_list, function(x){
      gene_id %in% as.character(x)
    }) |> unlist()
    #output_df <- data.frame(HOG=NA, OG=NA, )
    if(any(oml)){
      return(og[which(oml),])
    } else {
      tmp_output <- DataFrame(lapply(1:ncol(og[1,]), function(x) {x <- NA}))
      colnames(tmp_output) <- colnames(og[1,])
      return(tmp_output)
    }
  }
  gr$og <- lapply(bp_ids, function(x) check_in_og_list(x, og_ids))
  gr$hog <- lapply(gr$og, function(x) x$HOG) |> unlist()
  gr$counts <- do.call(rbind, lapply(gr$og, function(x) x[,grep("count", colnames(x))]) |> unlist())
  gr
}

genes_in_breakpoints_og <- SimpleList()
genes_in_breakpoints_og$Oki_Osa <- annotate_orthogroups(genes_in_breakpoints$Oki_Osa, pho, "Oki")
genes_in_breakpoints_og$Oki_Bar <- annotate_orthogroups(genes_in_breakpoints$Oki_Bar, pho, "Oki")
genes_in_breakpoints_og$Oki_Kum <- annotate_orthogroups(genes_in_breakpoints$Oki_Kum, pho, "Oki")

# How many genes in orthogroups are in breakpoint regions?
genes_in_breakpoints_og$Oki_Osa$hog |> is.na() |> table()
genes_in_breakpoints_og$Oki_Bar$hog |> is.na() |> table()
genes_in_breakpoints_og$Oki_Kum$hog |> is.na() |> table()

# Is there anything noteworthy about the orthogroup counts for genes in orthogroups?
xf <- rbind(
  # orthogroup counts of genes in breakpoint regions
  genes_in_breakpoints_og$Oki_Osa[!is.na(genes_in_breakpoints_og$Oki_Osa$hog)]$counts$Oki_count |> as.data.frame() |> dplyr::rename(count=1) |> dplyr::mutate(set="genes_in_breakpoints") |> as_tibble(),
  # orthogroup counts of NOT breakpoint regions
  pho[ which(!pho$HOG %in% genes_in_breakpoints_og$Oki_Osa$hog[!is.na(genes_in_breakpoints_og$Oki_Osa$hog)] ),]$Oki_count |> as.data.frame() |> dplyr::rename(count=1) |> dplyr::mutate(set="other_genes") |> as_tibble()
)
lapply(split(xf, xf$set), function(x) summary(x$count))
ggviolin(xf, x='set', y='count', fill='set') + theme_grey() + stat_compare_means(comparison=list(c('genes_in_breakpoints', 'other_genes')))

xf <- rbind(
  # orthogroup counts of genes in breakpoint regions
  genes_in_breakpoints_og$Oki_Osa[!is.na(genes_in_breakpoints_og$Oki_Osa$hog)]$counts$Oki_count |> as.data.frame() |> dplyr::rename(count=1) |> dplyr::mutate(set="genes_in_breakpoints") |> as_tibble() |> dplyr::filter(count>1),
  # orthogroup counts of NOT breakpoint regions
  pho[ which(!pho$HOG %in% genes_in_breakpoints_og$Oki_Osa$hog[!is.na(genes_in_breakpoints_og$Oki_Osa$hog)] ),]$Oki_count |> as.data.frame() |> dplyr::rename(count=1) |> dplyr::mutate(set="other_genes") |> as_tibble() |> dplyr::filter(count>1)
)
lapply(split(xf, xf$set), function(x) summary(x$count))
ggviolin(xf, x='set', y='count', fill='set') + theme_grey() + stat_compare_means(comparison=list(c('genes_in_breakpoints', 'other_genes')))
```

Note that the above use the `N19.tsv` file that does not include ALL Okinawa-Osaka orthologues. For that, we need another file.

TODO: This is not in `BreakpointData` yet but I have it the folder I run Docker from.

# Paired orthologues
```{r paired_orthologues_1, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
read_pair_ortho <- function(file, sp1, sp2, field_sp1, field_sp2) {
  df <- read.delim(file)
  colnames(df) <- c("Orthogroup", sp1, sp2)
  df[[sp1]] <- replace_gene_ids(df[[sp1]], field=field_sp1)
  df[[sp2]] <- replace_gene_ids(df[[sp2]], field=field_sp2)
  df[[paste0(sp1, "_count")]] <- unlist(lapply(df[[sp1]], length))
  df[[paste0(sp2, "_count")]] <- unlist(lapply(df[[sp2]], length))
  df <- DataFrame(df)
  df
}

pair_ortho <- SimpleList()
pair_ortho$Oki_Osa <- read_pair_ortho('../../OKI2018_I69.v2.prot.longest.fa_1__v__OSKA2016v1.9.prot.longest.fa_1.tsv', "Oki", "Osa", 3, 3)
head(pair_ortho$Oki_Osa, n=15)

pair_ortho$Oki_Bar <- read_pair_ortho('../../OKI2018_I69.v2.prot.longest.fa_1__v__Bar2_p4.Flye.prot.longest.fa_1.tsv', "Oki", "Bar", 3, 2)
pair_ortho$Oki_Kum <- read_pair_ortho('../../OKI2018_I69.v2.prot.longest.fa_1__v__KUM-M3-7f.prot.longest.fa_1.tsv', "Oki", "Kum", 3, 2)
pair_ortho$Osa_Bar <- read_pair_ortho('../../OSKA2016v1.9.prot.longest.fa_1__v__Bar2_p4.Flye.prot.longest.fa_1.tsv', "Osa", "Bar", 3, 2)


annotate_orthogroup_pairs <- function(gr, og, sp){
  og_ids <- og[[sp]]
  bp_ids <- gr$gene_id
  check_in_og_list <- function(gene_id, og_list) {
    oml <- lapply(og_list, function(x){
      gene_id %in% as.character(x)
    }) |> unlist()
    #output_df <- data.frame(HOG=NA, OG=NA, )
    if(any(oml)){
      return(og[which(oml),])
    } else {
      tmp_output <- DataFrame(lapply(1:ncol(og[1,]), function(x) {x <- NA}))
      colnames(tmp_output) <- colnames(og[1,])
      return(tmp_output)
    }
  }
  df <- do.call(rbind, lapply(bp_ids, function(x) check_in_og_list(x, og_ids)))
  #gr$hog <- lapply(gr$og, function(x) x$HOG) |> unlist()
  #do.call(rbind, lapply(gr$og, function(x) x[,grep("count", colnames(x))]) )
  mcols(gr) <- cbind(mcols(gr), df)
  gr
}

genes_in_breakpoints_og_pair <- SimpleList()
genes_in_breakpoints_og_pair$Oki_Osa <- annotate_orthogroup_pairs(genes_in_breakpoints$Oki_Osa, pair_ortho$Oki_Osa, "Oki")
genes_in_breakpoints_og_pair$Oki_Bar <- annotate_orthogroup_pairs(genes_in_breakpoints$Oki_Bar, pair_ortho$Oki_Bar, "Oki")
genes_in_breakpoints_og_pair$Oki_Kum <- annotate_orthogroup_pairs(genes_in_breakpoints$Oki_Kum, pair_ortho$Oki_Kum, "Oki")
genes_in_breakpoints_og_pair$Osa_Bar <- annotate_orthogroup_pairs(genes_in_breakpoints$Osa_Bar, pair_ortho$Osa_Bar, "Osa")

orthogroups_matching_genes <- function(gene_list, orthogroups, sp, reverse=FALSE){
  o <- orthogroups[[sp]]
  o <- lapply(o, as.character)
  matching_ogs <- lapply(o, function(og){
    any(gene_list %in% og)
  }) |> unlist()
  if(reverse){
    matching_ogs <- !matching_ogs
  }
  orthogroups[matching_ogs,]
}


xf <- rbind(
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Oki_Osa$gene_id, pair_ortho$Oki_Osa, sp='Oki', reverse=FALSE) |> as_tibble() |> dplyr::mutate(set='genes_in_breakpoints'),
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Oki_Osa$gene_id, pair_ortho$Oki_Osa, sp='Oki', reverse=TRUE) |> as_tibble() |> dplyr::mutate(set='other_genes')
)

lapply(split(xf, xf$set), function(x) summary(x$Oki_count))
ggviolin(xf, x='set', y='Oki_count', fill='set') + theme_grey() + stat_compare_means(comparison=list(c('genes_in_breakpoints', 'other_genes'))) + ggtitle("Okinawa-Osaka: Orthogroup sizes for genes in vs. outside breakpoints")


xf <- rbind(
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Oki_Bar$gene_id, pair_ortho$Oki_Bar, sp='Oki', reverse=FALSE) |> as_tibble() |> dplyr::mutate(set='genes_in_breakpoints'),
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Oki_Bar$gene_id, pair_ortho$Oki_Bar, sp='Oki', reverse=TRUE) |> as_tibble() |> dplyr::mutate(set='other_genes')
)
lapply(split(xf, xf$set), function(x) summary(x$Oki_count))
ggviolin(xf, x='set', y='Oki_count', fill='set') + theme_grey() + stat_compare_means(comparison=list(c('genes_in_breakpoints', 'other_genes'))) + ggtitle("Okinawa-Barcelona: Orthogroup sizes for genes in vs. outside breakpoints")



xf <- rbind(
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Oki_Kum$gene_id, pair_ortho$Oki_Kum, sp='Oki', reverse=FALSE) |> as_tibble() |> dplyr::mutate(set='genes_in_breakpoints'),
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Oki_Kum$gene_id, pair_ortho$Oki_Kum, sp='Oki', reverse=TRUE) |> as_tibble() |> dplyr::mutate(set='other_genes')
)
lapply(split(xf, xf$set), function(x) summary(x$Oki_count))
ggviolin(xf, x='set', y='Oki_count', fill='set') + theme_grey() + stat_compare_means(comparison=list(c('genes_in_breakpoints', 'other_genes'))) + ggtitle("Okinawa-Kume: Orthogroup sizes for genes in vs. outside breakpoints")


xf <- rbind(
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Osa_Bar$gene_id, pair_ortho$Osa_Bar, sp='Osa', reverse=FALSE) |> as_tibble() |> dplyr::mutate(set='genes_in_breakpoints'),
  orthogroups_matching_genes(genes_in_breakpoints_og_pair$Osa_Bar$gene_id, pair_ortho$Osa_Bar, sp='Osa', reverse=TRUE) |> as_tibble() |> dplyr::mutate(set='other_genes')
)
lapply(split(xf, xf$set), function(x) summary(x$Osa_count))
ggviolin(xf, x='set', y='Osa_count', fill='set') + theme_grey() + stat_compare_means(comparison=list(c('genes_in_breakpoints', 'other_genes'))) + ggtitle("Osaka-Barcelona: Orthogroup sizes for genes in vs. outside breakpoints")

```

# Overlap with repeats

```{r repeats_1, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
annotate_reps <- function(wgo_gr, repeats, genes_gr, overlap="within") {
  wgo_gr <- sort(wgo_gr, ignore.strand=TRUE)
  repeats <- sort(repeats, ignore.strand=TRUE)
  # Some repeats overlap.
  # Modify the repeats so that each repeat region has only one name.
  # Note that regions with more than one name are simplified to the first - so
  # e.g. if you have an tandem and an LTR that overlap, whichever comes first will 
  # be the name here.
  rep_reduced <- GenomicRanges::split(reduce(repeats, ignore.strand=TRUE), elementMetadata(repeats)$Class) |> unlist() |> sort(ignore.strand=T)
  rep_reduced$Class <- names(rep_reduced)
  names(rep_reduced) <- NULL
  # Since I use repeats as an object name throughout the function, and since I am lazy,
  # overwrite the input argument repeats with this reduced granges.
  repeats <- sort(rep_reduced, ignore.strand=TRUE)
  categories <- wgo_gr$type |> unique()
  
  # add repeat annotations
  # Here, the subjectHits are the hits within wgo_gr. The queryHits are the repeat matches.
  ov <- findOverlaps(repeats, wgo_gr, type=overlap)
  wgo_gr$repeat_ids <- NA
  wgo_gr$repeat_ids[subjectHits(ov) |> unique()] <- CharacterList(split(repeats$Class[queryHits(ov)], subjectHits(ov))) |> unname()
  wgo_gr$repeat_count <- lapply(wgo_gr$repeat_ids, length) |> unlist()
  rep_lvls <- levels(as.factor(unique(unlist(lapply(wgo_gr$repeat_ids, as.character)))))
  wgo_gr$repeat_ids <- lapply(wgo_gr$repeat_ids, function(x) factor(x, levels=rep_lvls))
  tbs <- do.call(rbind, lapply(wgo_gr$repeat_ids, table)) |> as.data.frame()
  mcols(wgo_gr) <- cbind(mcols(wgo_gr), tbs)
  wgo_gr$repeat_width <- 0
  wgo_gr$repeat_width[subjectHits(ov) |> unique()] <- NumericList(split(width(repeats)[queryHits(ov)], subjectHits(ov))) |> unname()
  wgo_gr$repeat_width_sum <- lapply(wgo_gr$repeat_width, sum) |> unlist()
  wgo_gr$repeat_fraction <- wgo_gr$repeat_width_sum/width(wgo_gr)*100
  
  # Add gene annotations
  # Some gene annotations also overlap. Merge them and get rid of some of the names, since we don't really care about those corner cases here.
  genes_gr <- sort(genes_gr, ignore.strand=TRUE)
  genes_gr <- GenomicRanges::split(reduce(genes_gr, ignore.strand=TRUE), elementMetadata(genes_gr)$gene_id) |> unlist() |> sort(ignore.strand=T)
  genes_gr$gene_id <- names(genes_gr)
  ov <- findOverlaps(genes_gr, wgo_gr, type=overlap)
  wgo_gr$gene_ids <- NA
  wgo_gr$gene_ids[subjectHits(ov) |> unique()] <- CharacterList(split(genes_gr$gene_id[queryHits(ov)], subjectHits(ov))) |> unname()
  wgo_gr$gene_count <- lapply(wgo_gr$gene_ids, length) |> unlist()
  wgo_gr$gene_width <- 0
  wgo_gr$gene_width[subjectHits(ov) |> unique()] <- NumericList(split(width(genes_gr)[queryHits(ov)], subjectHits(ov))) |> unname()
  wgo_gr$gene_width_sum <- lapply(wgo_gr$gene_width, sum) |> unlist()
  wgo_gr$gene_fraction <- wgo_gr$gene_width_sum/width(wgo_gr)*100
  
  # signify whether a segment is more non-coding or more coding
  wgo_gr$coding_proportion <- wgo_gr$gene_fraction/wgo_gr$repeat_fraction
  coding_signs <- sign(wgo_gr$gene_width_sum-wgo_gr$repeat_width_sum)
  wgo_gr$coding_sign <- "other"
  wgo_gr$coding_sign[coding_signs<0] <- "repetitive"
  wgo_gr$coding_sign[coding_signs>0] <- "genic"

  wgo_gr$other_width <- width(wgo_gr) - wgo_gr$repeat_width_sum - wgo_gr$gene_width_sum
  wgo_gr
}
wgoa$within <- SimpleList()
wgoa$within$Oki_Osa <- annotate_reps(wgo$Oki_Osa, reps$Oki, genes$Oki)
wgoa$within$Oki_Bar <- annotate_reps(wgo$Oki_Bar, reps$Oki, genes$Oki)
wgoa$within$Oki_Kum <- annotate_reps(wgo$Oki_Kum, reps$Oki, genes$Oki)
wgoa$within$Osa_Bar <- annotate_reps(wgo$Osa_Bar, reps$Osa, genes$Osa)

wgoa$any <- SimpleList()
wgoa$any$Oki_Osa <- annotate_reps(wgo$Oki_Osa, reps$Oki, genes$Oki, overlap = "any")
wgoa$any$Oki_Bar <- annotate_reps(wgo$Oki_Bar, reps$Oki, genes$Oki, overlap = "any")
wgoa$any$Oki_Kum <- annotate_reps(wgo$Oki_Kum, reps$Oki, genes$Oki, overlap = "any")
wgoa$any$Osa_Bar <- annotate_reps(wgo$Osa_Bar, reps$Osa, genes$Osa, overlap = "any")
```

## Overlap plots - Within bounds
### Okinawa-Osaka: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_1, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$within$Oki_Osa[order(wgoa$within$Oki_Osa$gene_fraction / wgoa$within$Oki_Osa$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$within$Oki_Osa |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Osaka: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$within$Oki_Osa |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Osaka: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$within$Oki_Osa |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Osaka: Ratio of genic fraction to repeat fraction")
p3

wgoa$within$Oki_Osa |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Okinawa-Osaka: Segment majority by alignment category")
```

### Okinawa-Barcelona: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_2, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$within$Oki_Bar[order(wgoa$within$Oki_Bar$gene_fraction / wgoa$within$Oki_Bar$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$within$Oki_Bar |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Barcelona: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$within$Oki_Bar |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Barcelona: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$within$Oki_Bar |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Barcelona: Ratio of genic fraction to repeat fraction")
p3

wgoa$within$Oki_Bar |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Okinawa-Barcelona: Segment majority by alignment category")
```


### Okinawa-Kume: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_3, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$within$Oki_Kum[order(wgoa$within$Oki_Kum$gene_fraction / wgoa$within$Oki_Kum$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$within$Oki_Kum |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Kume: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$within$Oki_Kum |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Kume: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$within$Oki_Kum |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Kume: Ratio of genic fraction to repeat fraction")
p3

wgoa$within$Oki_Kum |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Okinawa-Kume: Segment majority by alignment category")
```


### Osaka-Barcelona: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_4, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$within$Osa_Bar[order(wgoa$within$Osa_Bar$gene_fraction / wgoa$within$Osa_Bar$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$within$Osa_Bar |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Osaka-Barcelona: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$within$Osa_Bar |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Osaka-Barcelona: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$within$Osa_Bar |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Osaka-Barcelona: Ratio of genic fraction to repeat fraction")
p3

wgoa$within$Osa_Bar |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Osaka-Barcelona: ")
```

## Overlap plots - Any (redundant) overlaps
### Okinawa-Osaka: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_1, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$any$Oki_Osa[order(wgoa$any$Oki_Osa$gene_fraction / wgoa$any$Oki_Osa$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$any$Oki_Osa |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Osaka: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$any$Oki_Osa |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Osaka: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$any$Oki_Osa |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Osaka: Ratio of genic fraction to repeat fraction")
p3

wgoa$any$Oki_Osa |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Okinawa-Osaka: Segment majority by alignment category")
```

### Okinawa-Barcelona: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_2, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$any$Oki_Bar[order(wgoa$any$Oki_Bar$gene_fraction / wgoa$any$Oki_Bar$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$any$Oki_Bar |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Barcelona: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$any$Oki_Bar |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Barcelona: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$any$Oki_Bar |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Barcelona: Ratio of genic fraction to repeat fraction")
p3

wgoa$any$Oki_Bar |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Okinawa-Barcelona: Segment majority by alignment category")
```


### Okinawa-Kume: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_3, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$any$Oki_Kum[order(wgoa$any$Oki_Kum$gene_fraction / wgoa$any$Oki_Kum$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$any$Oki_Kum |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Kume: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$any$Oki_Kum |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Kume: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$any$Oki_Kum |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Okinawa-Kume: Ratio of genic fraction to repeat fraction")
p3

wgoa$any$Oki_Kum |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Okinawa-Kume: Segment majority by alignment category")
```


### Osaka-Barcelona: Segment genic/repetitive fractions per alignment category ("within" bounds)
```{r repeats_within_4, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, dev=c("svg", "png")}
library(ggpubr)
wgoa$any$Osa_Bar[order(wgoa$any$Osa_Bar$gene_fraction / wgoa$any$Osa_Bar$repeat_fraction, decreasing=T)]
p1 <- ggboxplot(wgoa$any$Osa_Bar |> as.data.frame(), x='type', y='repeat_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Osaka-Barcelona: Fraction of alignment category that fully bounds repeats")
p1

p2 <- ggboxplot(wgoa$any$Osa_Bar |> as.data.frame(), x='type', y='gene_fraction', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Osaka-Barcelona: Fraction of alignment category that fully bounds genes")
p2
(p1 / p2)

p3 <- ggboxplot(wgoa$any$Osa_Bar |> as.data.frame(), x='type', y='coding_proportion', fill='type') + theme_grey() + stat_compare_means(comparisons = list(c('breakpoint region', 'bridge region'), c('breakpoint region', 'collinear alignment'), c('breakpoint region', 'isolated alignment'), c('collinear alignment', 'isolated alignment')), hide.ns = T) + ggtitle("Osaka-Barcelona: Ratio of genic fraction to repeat fraction")
p3

wgoa$any$Osa_Bar |> as.data.frame() |> dplyr::mutate(coding_sign=factor(coding_sign, levels=names(sort(table(coding_sign), decreasing=F))) ) |> ggplot() + aes(x=type, fill=coding_sign) + geom_bar() + ggtitle("Osaka-Barcelona: ")
```

# Session information

```{r sessionInfo}
sessionInfo()
```
