---
title: "Load genomic break data"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Load genomic break data}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_knit$set(verbose = TRUE, cache = TRUE)
```

Introduction
============

This vignette loads the genomic breaks data, consolidates colinear regions,
extracts unaligned and unmapped regions, transfers annotation data and saves the
resulting objects in a serialised R object (`RData` file) for reuse in other
vignettes.

Related objects are stored in lists to avoid cluttering the environment.

Packages and data
=================


```{r load_pacakges_and_data}
suppressPackageStartupMessages({
  library('GenomicBreaks')
  library('ggplot2')
  library("BreakpointsData")
})
genomes <- OikScrambling:::loadAllGenomes(compat = FALSE)
```

Genomic breaks
==============

Long/short arm information
--------------------------

Short / long arm annotation will be done by the `GenomicBreaks::flagLongShort()`
function.

```{r long_and_short_arms}
loadLongShort <- function(file, genome) {
  file <- system.file(paste0("extdata/Annotations/", file), package = "BreakpointsData")
  gr <- rtracklayer::import.gff3(file)
  gr$source <- gr$type <- gr$score <- gr$phase <- NULL
  GRanges(gr, seqinfo = seqinfo(getBSgenome(genome)), strand = "*")
}

flagLongShort_ <- function(gr, longShort) {
  genomeT <- gr |> genome() |> unique()
  if(genomeT %in% names(longShort))
    gr <- flagLongShort(gr, longShort[[genomeT]])
  if("GBreaks" %in% class(gr)) {
      genomeQ <- gr$query |> genome() |> unique()
      if(genomeQ %in% names(longShort)) {
        # sort, flag, unsort, extract flag
        grq <- gr$query
        grq$idx <- seq_along(grq)
        grq <- sort(grq, ignore.strand = TRUE)
        grq <- flagLongShort(grq, longShort[[genomeQ]])
        gr$query$Arm <- grq$Arm[order(grq$idx)]
      }
  }
  gr
}

longShort <- SimpleList()
longShort$OKI2018.I69   <- loadLongShort("OKI2018_I69.v2/OKI2018_I69.arms.gff3", "OKI2018.I69")
longShort$OSKA2016v1.9  <- loadLongShort("OSKA2016v1.9/OSKA2016v1.9.arms.gff3",  "OSKA2016v1.9")
longShort$Bar2.p4       <- loadLongShort("Bar2_p4.Flye/Bar2_p4.Flye.arms.gff3",  "Bar2.p4")

longShort
```

Repeat regions
--------------

Load from `BreakpointsData` package via `OikScrambling:::loadAllRepeats()`

```{r load_repeats}
(reps <- OikScrambling:::loadAllRepeats(compat = FALSE))

annotateWithReps <-  function(x, rep) UseMethod("annotateWithReps")

annotateWithReps.GRanges <- function(x, rep) {
  genome <- x |> genome() |> unique()
  # Inspired from CAGEr:::ranges2names
  o <- findOverlaps(x, rep[[genome]], ignore.strand = TRUE)
  o <- as(o, "List")
  o <- extractList(rep[[genome]]$Class |> as.character(), o)
  o <- endoapply(o, unique)
  o[sapply(o, length) == 0] <- NA
  x$rep <- o
  x
}

overlapLength.GRanges <- function(x, rep) {
  genome <- x |> genome() |> unique()
  # Inspired from CAGEr:::ranges2names
  redRep <- reduce(rep[[genome]])
  o <- findOverlaps(x, redRep, ignore.strand = TRUE)
  o <- as(o, "List")
  repGrl <- extractList(redRep, o)
  x$repOvlp <- pintersect(x, repGrl) |> width() |> sum()
  x
}

annotateWithReps.GBreaks <-  function(x,       rep) {
  x$query <- annotateWithReps.GRanges(x$query, rep)
  x       <- annotateWithReps.GRanges(x,       rep)
  x$query <- overlapLength.GRanges   (x$query, rep)
  x       <- overlapLength.GRanges   (x,       rep)
  x
}

annotateWithReps.SimpleList <- function(x, rep)
  sapply(x, annotateWithReps, rep) |> SimpleList()
```

Transcript annotations
----------------------

```{r annotate_transcripts}
(transcripts <- OikScrambling:::loadAllTranscriptsGR(compat = FALSE))

annotateWithTranscripts <-  function(x, transcripts) UseMethod("annotateWithTranscripts")

annotateWithTranscripts.GRanges <- function(x, transcripts) {
  # Taken from CAGEr (and I am the author)
  ranges2names <- function (rangesA, rangesB) {
    if (is.null(names(rangesB))) 
        stop(sQuote("rangesB"), " must contain have names.")
    names <- findOverlaps(rangesA, rangesB)
    names <- as(names, "List")
    names <- extractList(names(rangesB), names)
    names <- unique(names)
    names <- unstrsplit(names, ";")
    Rle(names)
  }
  genomeT <- x |> genome() |> unique()
  x$transcripts <- ranges2names(x, transcripts[[genomeT]])
  x$transcripts[x$transcripts == ''] <- NA
  x
}

annotateWithTranscripts.GBreaks <- function(x, transcripts) {
  x$query <- annotateWithTranscripts.GRanges(x$query, transcripts)
  x       <- annotateWithTranscripts.GRanges(x,       transcripts)
  x
}

annotateWithTranscripts.SimpleList <- function(x, transcripts)
  sapply(x, annotateWithTranscripts, transcripts) |> SimpleList()
```

Mapped alignments
-----------------

Let's load data from genome alignments, using the copy distributed in the
`BreakpointsData` package.

### _Oikopleura_

```{r GBreaks_object_oik, cache=TRUE}
# Local function to add extra annotation on long/short arms while loading data
load_genomic_breaks_ <- function(file, genomeT, genomeQ, longShort=NULL) {
  file <- system.file(paste0("extdata/Oidioi_pairwise_v3/", file), package = "BreakpointsData")
  gb <- load_genomic_breaks(file, getBSgenome(genomeT),  getBSgenome(genomeQ))
  flagLongShort_(gb, longShort)
}

gbs <- SimpleList()

gbs$Oki_Osa <- load_genomic_breaks_("OKI2018_I69_1.0__OSKA2016v1.9.gff.gz", "OKI2018.I69",  "OSKA2016v1.9", longShort)
gbs$Oki_Bar <- load_genomic_breaks_("OKI2018_I69_1.0__Bar2_p4.gff.gz",      "OKI2018.I69",  "Bar2.p4",      longShort)
gbs$Oki_Kum <- load_genomic_breaks_("OKI2018_I69_1.0__KUM-M3-7f.gff.gz",    "OKI2018.I69",  "KUM.M3.7f",    longShort)
gbs$Oki_Aom <- load_genomic_breaks_("OKI2018_I69_1.0__AOM-5-5f.gff.gz",     "OKI2018.I69",  "AOM.5.5f",     longShort)
gbs$Oki_Nor <- load_genomic_breaks_("OKI2018_I69_1.0__OdB3.gff.gz",         "OKI2018.I69",  "OdB3",         longShort)

gbs$Osa_Oki <- load_genomic_breaks_("OSKA2016v1.9__OKI2018_I69_1.0.gff.gz", "OSKA2016v1.9", "OKI2018.I69",  longShort)
gbs$Osa_Bar <- load_genomic_breaks_("OSKA2016v1.9__Bar2_p4.gff.gz",         "OSKA2016v1.9", "Bar2.p4",      longShort)
gbs$Osa_Kum <- load_genomic_breaks_("OSKA2016v1.9__KUM-M3-7f.gff.gz",       "OSKA2016v1.9", "KUM.M3.7f",    longShort)
gbs$Osa_Aom <- load_genomic_breaks_("OSKA2016v1.9__AOM-5-5f.gff.gz",        "OSKA2016v1.9", "AOM.5.5f",     longShort)
gbs$Osa_Nor <- load_genomic_breaks_("OSKA2016v1.9__OdB3.gff.gz",            "OSKA2016v1.9", "OdB3",         longShort)

gbs$Bar_Oki <- load_genomic_breaks_("Bar2_p4__OKI2018_I69_1.0.gff.gz",      "Bar2.p4",     "OKI2018.I69",   longShort)
gbs$Bar_Osa <- load_genomic_breaks_("Bar2_p4__OSKA2016v1.9.gff.gz",         "Bar2.p4",     "OSKA2016v1.9",  longShort)
gbs$Bar_Kum <- load_genomic_breaks_("Bar2_p4__KUM-M3-7f.gff.gz",            "Bar2.p4",     "KUM.M3.7f",     longShort)
gbs$Bar_Aom <- load_genomic_breaks_("Bar2_p4__AOM-5-5f.gff.gz",             "Bar2.p4",     "AOM.5.5f",      longShort)
gbs$Bar_Nor <- load_genomic_breaks_("Bar2_p4__OdB3.gff.gz",                 "Bar2.p4",     "OdB3",          longShort)

Oik_Oik <- names(gbs)
```

### _Ciona_

```{r GBreaks_object_Ciona, dependson="GBreaks_object_Oik", cache=TRUE}
gbs$Ply_Ros <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_int_P__C_int_R.gff.gz",          package = "BreakpointsData"),    NULL,     NULL)
gbs$Ply_Rob <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_int_P__C_rob_HT.gff.gz",         package = "BreakpointsData"),    NULL,     NULL)
gbs$Ply_Sav <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_int_P__C_sav.gff.gz",            package = "BreakpointsData"),    NULL,     NULL)
gbs$Ply_Oki <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_int_P__OKI2018_I69_1.0.gff.gz",  package = "BreakpointsData"),    NULL, genomes$OKI2018.I69)

gbs$Rob_Ros <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_rob_HT__C_int_R.gff.gz",         package = "BreakpointsData"),    NULL,     NULL)
gbs$Rob_Ply <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_rob_HT__C_int_P.gff.gz",         package = "BreakpointsData"),    NULL,     NULL)
gbs$Rob_Sav <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_rob_HT__C_sav.gff.gz",           package = "BreakpointsData"),    NULL,     NULL)
gbs$Rob_Oki <- load_genomic_breaks(system.file("extdata/Ciona_pairwise_v3/C_rob_HT__OKI2018_I69_1.0.gff.gz", package = "BreakpointsData"),    NULL,  genomes$OKI2018.I69)
```

### _Drosophila_

```{r GBreaks_object_Droso, dependson="GBreaks_object_Ciona", cache=TRUE}
gbs$Dme_Dbu <- load_genomic_breaks(system.file("extdata/Insects_pairwise_v3/Dmel__Dbus_ASM1175060v1.gff.gz",     package = "BreakpointsData"),    NULL,     NULL)
gbs$Dme_Dsu <- load_genomic_breaks(system.file("extdata/Insects_pairwise_v3/Dmel__RU_Dsub_v1.1.gff.gz",          package = "BreakpointsData"),    NULL,     NULL)
gbs$Dme_Dya <- load_genomic_breaks(system.file("extdata/Insects_pairwise_v3/Dmel__Prin_Dyak_Tai18E2_2.0.gff.gz", package = "BreakpointsData"),    NULL,     NULL)
gbs$Dme_Dma <- load_genomic_breaks(system.file("extdata/Insects_pairwise_v3/Dmel__Dmau_ASM438214v1.gff.gz",      package = "BreakpointsData"),    NULL,     NULL)
```

### _Caenorhabditis_

```{r GBreaks_object_Caeno, dependson="GBreaks_object_Droso", cache=TRUE}
gbs$Cni_Cbr <- load_genomic_breaks(system.file("extdata/Nematodes_pairwise/nigoni_briggsae.07.postmasked.gff.gz", package = "BreakpointsData"), type = "match")
gbs$Cni_Cre <- load_genomic_breaks(system.file("extdata/Nematodes_pairwise/nigoni_remanei.07.postmasked.gff.gz", package = "BreakpointsData"), type = "match")
gbs$Cni_Cin <- load_genomic_breaks(system.file("extdata/Nematodes_pairwise/nigoni_inopinata.07.postmasked.gff.gz", package = "BreakpointsData"), type = "match")
gbs$Cbr_Cni <- load_genomic_breaks(system.file("extdata/Nematodes_pairwise/briggsae_nigoni.07.postmasked.gff.gz", package = "BreakpointsData"), type = "match")
gbs$Cbr_Cre <- load_genomic_breaks(system.file("extdata/Nematodes_pairwise/briggsae_remanei.07.postmasked.gff.gz", package = "BreakpointsData"), type = "match")
gbs$Cbr_Cel <- load_genomic_breaks(system.file("extdata/Nematodes_pairwise/briggsae_elegans.07.postmasked.gff.gz", package = "BreakpointsData"), type = "match")
```

### Annotate Oikopleura

```{r GBreaks_object_final, dependson="GBreaks_object_Caeno", cache=TRUE}
gbs[Oik_Oik] <-  annotateWithReps(gbs[Oik_Oik], reps)
gbs[Oik_Oik] <- annotateWithTranscripts(gbs[Oik_Oik], transcripts)
gbs <- sapply(gbs, flagAll) |> SimpleList()
```

Unaligned regions
-----------------

Note that the unaligned regions are strandless and unpaired by definition.

```{r unal}
unal  <- BiocParallel::bplapply(gbs, cleanGaps) |> SimpleList()
unal[Oik_Oik] <- BiocParallel::bplapply(unal[Oik_Oik], flagLongShort_, longShort)
unal[Oik_Oik] <- BiocParallel::bplapply(unal[Oik_Oik], annotateWithReps, reps)
unal[Oik_Oik] <- BiocParallel::bplapply(unal[Oik_Oik], annotateWithTranscripts, transcripts)
```

Coalescing alignments
---------------------

### Coalesce

We call these coalesced regions “mapped regions”.  Some of the bases in the
region are aligned and some not (see the “mapped unaligned regions” later).

```{r coalescing_algorithm, cache=TRUE, dependson="GBreaks_object"}
coa <- BiocParallel::bplapply(gbs, coalesce_contigs) |> SimpleList()
coa[Oik_Oik] <- BiocParallel::bplapply(coa[Oik_Oik],  flagLongShort_, longShort)
coa[Oik_Oik] <- annotateWithReps(coa[Oik_Oik], reps)
coa[Oik_Oik] <- annotateWithTranscripts(coa[Oik_Oik], transcripts)
coa <- sapply(coa, flagAll) |> SimpleList()
```

### Flag non-coalesced

Mark the regions that are identical in the aligned and the mapped objects with
a `nonCoa` flag meaning _non coalesced_.

```{r mark_non_coalesced_regions}
for(name in names(coa)) {
  coa[[name]]$nonCoa <- coa[[name]] %in% gbs [[name]]
}

for(name in names(gbs)) {
  gbs[[name]]$nonCoa <- gbs[[name]] %in% coa [[name]]
}
```

Unmapped regions
----------------

### Generate

We can not call them “uncoalesced” because this would also qualify aligned
regions that were not colinear with any other region.

```{r unmap}
unmap  <- BiocParallel::bplapply(coa, cleanGaps) |> SimpleList()
unmap[Oik_Oik] <- BiocParallel::bplapply(unmap[Oik_Oik], flagLongShort_, longShort)
unmap[Oik_Oik] <- BiocParallel::bplapply(unmap[Oik_Oik], annotateWithReps, reps)
unmap[Oik_Oik] <- BiocParallel::bplapply(unmap[Oik_Oik], annotateWithTranscripts, transcripts)
```

### Flag non-coalesced

Mark the regions that are identical in the unaligned and the unmapped objects
the same `nonCoa` flag.  The flag is `TRUE` by definition in all unmapped
objects, but we keep it so that objects have similar structures.

```{r mark_non_coalesced_regions2}
for(name in names(unal)) {
  unal[[name]]$nonCoa  <- unal[[name]]  %in% unmap [[name]]
}

for(name in names(unmap)) {
  unmap[[name]]$nonCoa <- unmap[[name]] %in% unal  [[name]]
}
```

Whole-genome objects
--------------------

Let's have objects that cover the whole genomes (with the possible exception
of the telomeric regions) and contain _isolated alignments_, _breakpoint regions_,
_colinear alignments_ and _bridge regions_.  These are `GRanges` objects, not
`GBreaks`, since they contain unaligned regions.

```{r}
makeWholeGenomeObject <- function(aligned, unaligned) {
  # Isolated alignments are aligned regions not in collinear regions
  iso <- granges(aligned[aligned$nonCoa]) |> plyranges::mutate(type = "isolated alignment")
  # Breakpoint regions are unaligned regions not in collinear regions
  brk <- granges(unaligned[unaligned$nonCoa])|> plyranges::mutate(type = "breakpoint region")
  # Collinear alignments are aligned regions in collinear regions
  col <- granges(aligned[!aligned$nonCoa]) |> plyranges::mutate(type = "collinear alignment")
  # Bridge regions are unaligned regions in collinear regions
  bri <- granges(unaligned[!unaligned$nonCoa]) |> plyranges::mutate(type = "bridge region")
  
  wholeGenome <- c(iso, brk, col, bri) |> sort(ignore.strand = TRUE)
  wholeGenome$type <- factor(wholeGenome$type)
  wholeGenome
}

wgo <- mapply(makeWholeGenomeObject, gbs, unal) |> SimpleList()
```

```{r calc_proportion_of_genome_region_classes}
for_wgo_barplots <- sapply(wgo, \(gr) tapply(width(gr), gr$type, sum)) |>
  as.data.frame() |>
  tibble::as_tibble(rownames = "type") |>
  tidyr::pivot_longer(!type) |>
  dplyr::mutate(distClass = OikScrambling:::compDistClass(name)) |>
  dplyr::mutate(genus = OikScrambling:::compGenus(name))

p1 <- ggplot(for_wgo_barplots |> dplyr::filter(genus == "Oikopleura", distClass == "distant")) +
  aes(name, value, fill = type) +
  ggplot2::coord_flip() +
  geom_bar( stat = "identity") +
  ggtitle("Oki or Kume vs other populations")

p2 <- ggplot(for_wgo_barplots |> dplyr::filter(genus == "Oikopleura", distClass == "intermediate")) +
  aes(name, value, fill = type) +
  ggplot2::coord_flip() +
  geom_bar( stat = "identity")  +
  ggtitle("North Atlantic vs North Pacific")

p3 <- ggplot(for_wgo_barplots |> dplyr::filter(genus == "Oikopleura", distClass == "same_or_sister")) +
  aes(name, value, fill = type) +
  ggplot2::coord_flip() +
  geom_bar( stat = "identity") +
  ggtitle("same population")

p4 <- ggplot(for_wgo_barplots |> dplyr::filter(genus == "Drosophila")) +
  aes(name, value, fill = type) +
  ggplot2::coord_flip() +
  geom_bar( stat = "identity") +
  ggtitle("Drosophila (various evol. distances)")

p5 <- ggplot(for_wgo_barplots |> dplyr::filter(genus == "Ciona")) +
  aes(name, value, fill = type) +
  ggplot2::coord_flip() +
  geom_bar( stat = "identity") +
  ggtitle("Ciona (various evol. distances)")

p6 <- ggplot(for_wgo_barplots |> dplyr::filter(genus == "Caenorhabditis")) +
  aes(name, value, fill = type) +
  ggplot2::coord_flip() +
  geom_bar( stat = "identity") +
  ggtitle("Caenorhabditis (various evol. distances)")
```

We can see that:

 - The larger size of Okinawa and Kume genomes is explained by sequences that
   are not aligned.  (Repeats ?)
 - The fraction of isolated alignments is always small, but it is comparatively
   larger in Oiks compared to Drosophila and Ciona.
 - The fraction of bridge regions increases with evolutionary distance, until
   becoming larger than the fraction of colinear alignments (_D. melanogaster_ /
   _D. buskii_, _C. savignyi_ / _C intestinalis or robusta_).

```{r proportion_of_genome_region_classes, fig.width=6, fig.height=18, dev=c("svg", "pdf", "png"), fig.ext=c("svg", "pdf", "png")}
library("patchwork")
p1 / p2 / p3 / p4 / p5 / p6
```

In the next plot, replicate pairs of genomes are merged.

```{r proportion_of_genome_region_classes_oiks, fig.width=8, fig.height=10, dev=c("svg", "pdf", "png"), fig.ext=c("svg", "pdf", "png")}
for_wgo_barplots2 <- sapply(wgo, \(gr) tapply(width(gr), gr$type, sum)) |>
  prop.table(2) |>
  as.data.frame()

for_wgo_barplots2$Osa_Oki <- rowMeans(for_wgo_barplots2[,c("Osa_Oki", "Oki_Osa")])
for_wgo_barplots2$Oki_Osa <- NULL

for_wgo_barplots2$Bar_Oki <- rowMeans(for_wgo_barplots2[,c("Bar_Oki", "Oki_Bar")])
for_wgo_barplots2$Oki_Bar <- NULL

for_wgo_barplots2$Osa_Bar <- rowMeans(for_wgo_barplots2[,c("Osa_Bar", "Bar_Osa")])
for_wgo_barplots2$Bar_Osa <- NULL

for_wgo_barplots2 <- for_wgo_barplots2 |>
  tibble::as_tibble(rownames = "type") |>
  tidyr::pivot_longer(!type) |>
  dplyr::mutate(distClass = OikScrambling:::compDistClass(name)) |>
  dplyr::mutate(genus = OikScrambling:::compGenus(name))

for_wgo_barplots2$type <- for_wgo_barplots2$type |> factor(c("isolated alignment", "bridge region", "collinear alignment", "breakpoint region"))

for_wgo_barplots2
for_wgo_barplots2$distClass <-
  factor(for_wgo_barplots2$distClass,
         labels=c("Same species", "Close", "Intermediate", "Distant", "Different_genus"))
for_wgo_barplots2$name <- for_wgo_barplots2$name |> toupper() |> sub(pat="_", rep="–")
for_wgo_barplots2$type <-
  factor(for_wgo_barplots2$type,
         labels = c("Isolated alignment", "Bridge region", "Collinear alignment", "Breakpoint region"))

ggplot(for_wgo_barplots2 |> dplyr::filter(genus == "Oikopleura")) +
  aes(name, value, fill = type) +
  ggplot2::coord_flip() +
  geom_bar( stat = "identity", color = "black", linewidth = 0.2) +
  ggtitle("Proportion of the genome in aligned, bridge and breakpoint regions") +
  facet_grid(distClass ~ ., scales = "free", space = "free") +
  theme_bw() +
  scale_y_continuous("", labels = scales::percent_format(accuracy = 5L), position = "right") +
  scale_x_discrete("") +
  scale_fill_manual(values = c("#f79e87", "#8dd3c7", "#80b1d3", "#f9f5b0"))
```

Bridge regions
--------------

We can pair the unaligned regions that are between two colinearly aligned regions.

```{r mappedUnaligned, cache = TRUE, dependson="GBreaks_object"}
bri <- BiocParallel::bplapply(gbs, bridgeRegions) |> as("SimpleList")

bri[Oik_Oik] <- BiocParallel::bplapply(bri[Oik_Oik], flagLongShort_, longShort)
bri[Oik_Oik] <- annotateWithReps(bri[Oik_Oik], reps)
bri[Oik_Oik] <- annotateWithTranscripts(bri[Oik_Oik], transcripts)
```

Translocated regions
--------------------

Here we compute new `GBreaks` objects representing the intervals between two
regions that would be colinear if there would not be a translocation separating
them.

```{r translocated_regions, cache=TRUE, dependson="coalescing_algorithm"}
traGaps <- function(coa) {
  # The input MUST already be coalesced.
  tra <- flagTranslocations(coa)
  # Consider both sides
  tra$tra <- tra$tra | tra$query$tra
  # Then, remove translocated regions
  tra <- filterTranslocations(tra, remove = TRUE)
  # Finally, extract the newly "unaligned mapped" regions.
  # They contain the gaps left by the removal of the translocated regions.
  bridgeRegions(tra)
}

tra <- BiocParallel::bplapply(coa, traGaps) |> as("SimpleList")

tra[Oik_Oik] <- BiocParallel::bplapply(tra[Oik_Oik], flagLongShort_, longShort)
tra[Oik_Oik] <- annotateWithReps(tra[Oik_Oik], reps)
tra[Oik_Oik] <- annotateWithTranscripts(tra[Oik_Oik], transcripts)
```

Coalesce again
--------------

We remove the translocated regions that interrupt colinearity, where one of
the colinear pairs is closer than 200 bp.

```{r re_coalesce, cache=TRUE, dependson="coalescing_algorithm"}
removeTranslocationsOnTargetGenome <- function(gb) {
  gb <- flagTranslocations(gb)
  gb <- dist2next(gb, step = 2, ignore.strand = TRUE)
  idx <- 1 + which( gb$tra & (gb$tdist < 200 | gb$qdist < 200) )
  if(length(idx) != 0)
    gb <- gb[-idx]
  coalesce_contigs(gb)
}
removeTranslocationsOnBothGenomes <- function(gb)
  gb |>
    removeTranslocationsOnTargetGenome() |>
    swap() |> sort(i=T) |>
    removeTranslocationsOnTargetGenome() |>
    swap() |> sort(i=T)

coa2 <- BiocParallel::bplapply(coa, removeTranslocationsOnBothGenomes) |> SimpleList()

coa2[Oik_Oik] <- BiocParallel::bplapply(coa2[Oik_Oik], flagLongShort_, longShort)
coa2[Oik_Oik] <- annotateWithReps(coa2[Oik_Oik], reps)
coa2[Oik_Oik] <- annotateWithTranscripts(coa2[Oik_Oik], transcripts)
coa2 <- sapply(coa2, flagAll) |> SimpleList()
```

Unmapped regions 2
------------------

The intervals between double-coalesced regions.

```{r unmap2}
unmap2  <- BiocParallel::bplapply(coa2, cleanGaps) |> SimpleList()
unmap2[Oik_Oik] <- BiocParallel::bplapply(unmap2[Oik_Oik], flagLongShort_, longShort)
unmap2[Oik_Oik] <- BiocParallel::bplapply(unmap2[Oik_Oik], annotateWithReps, reps)
unmap2[Oik_Oik] <- BiocParallel::bplapply(unmap2[Oik_Oik], annotateWithTranscripts, transcripts)
```

Translocated regions 2
----------------------

To check that we really removed the small ones as intented.

```{r translocated_regions2, cache=TRUE, dependson="re_coalesce"}
tra2 <- BiocParallel::bplapply(coa2, traGaps) |> as("SimpleList")

tra2[Oik_Oik] <- BiocParallel::bplapply(tra2[Oik_Oik], flagLongShort_, longShort)
tra2[Oik_Oik] <- annotateWithReps(tra2[Oik_Oik], reps)
tra2[Oik_Oik] <- annotateWithTranscripts(tra2[Oik_Oik], transcripts)
```


Numbers of blocks
-----------------

```{r lengths}
bp_summary <- 
  rbind(
    gbs     = sapply(gbs, length),
    unal    = sapply(unal, length),
    coa     = sapply(coa, length),
    unmap   = sapply(unmap, length),
    unmap2  = sapply(unmap2, length),
    bri = sapply(bri, length),
    tra     = sapply(tra, length),
    tra2    = sapply(tra2, length),
    coa2    = sapply(coa2, length)
  ) |> t() |> data.frame()

sapply(bp_summary, \(x) tapply(x, row.names(bp_summary) |> OikScrambling:::compDistance(), mean))
sapply(bp_summary, \(x) tapply(x, row.names(bp_summary) |> OikScrambling:::compDistance(), median))
sapply(bp_summary, \(x) tapply(x, row.names(bp_summary) |> OikScrambling:::compDistance(), sd))
```

Fraction of the genome aligned or mapped
----------------------------------------

```{r fraction_aligned}
  aligned_tot  <- sapply(gbs,   \(x) sum(width(x)))
  mapped_tot   <- sapply(coa,   \(x) sum(width(x)))
  mapped2_tot  <- sapply(coa2,  \(x) sum(width(x)))
unaligned_tot  <- sapply(unal,   \(x) sum(width(x)))
unmapped_tot   <- sapply(unmap,  \(x) sum(width(x)))
unmapped2_tot  <- sapply(unmap2, \(x) sum(width(x)))

(align_summary <- 100 * cbind(
  align_frac = aligned_tot / ( aligned_tot + unaligned_tot ),
  map_frac   = mapped_tot  / ( mapped_tot  + unmapped_tot ),
  map2_frac  = mapped2_tot / ( mapped2_tot + unmapped2_tot)
 )|> as.data.frame())

sapply(align_summary, \(x) tapply(x, row.names(align_summary) |> OikScrambling:::compDistance(), mean))   |> round(1)
sapply(align_summary, \(x) tapply(x, row.names(align_summary) |> OikScrambling:::compDistance(), median)) |> round(1)
sapply(align_summary, \(x) tapply(x, row.names(align_summary) |> OikScrambling:::compDistance(), sd))     |> round(1)
```

Summary
-------

```{r summary}
df <- cbind(
  gbs = sapply(gbs, length),
  coa = sapply(coa, length),
  coa2 = sapply(coa2, length)
) |> as.data.frame() |>
  dplyr::arrange(gbs = gbs - coa - coa2, coa = coa - coa2)

df$pair <- row.names(df)

ggplot(df |> tidyr::pivot_longer(!pair)) +
  aes(pair, value, fill = name) +
  geom_bar( stat = "identity" ) +
  ggplot2::coord_flip() +
  ggtitle("Cumulative plot (gbs ⊃ coa ⊃ coa2) of the computed genomic regions")
```

Save data
=========

```{r save_data}
save(gbs, unal, coa, unmap, bri, tra, tra2, coa2, unmap2, wgo, longShort, file = "BreakPoints.Rdata")
system("echo '9f273f099ecbfa44899b6c343d1382f1  BreakPoints.Rdata' | md5sum -c", intern = TRUE)
```

Session information
===================

```{r session_info}
sessionInfo()
```
