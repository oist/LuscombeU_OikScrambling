---
title: "Repeat regions"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Repeat regions}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(cache = TRUE, cache.lazy = FALSE)
knitr::opts_knit$set(verbose = TRUE)
```

# Introduction

Regions matching repeat annotations in the _target_ or the _query_ genome.

# Load R pacakges and data

```{r load_packages_and_data}
library('OikScrambling') |> suppressPackageStartupMessages()
(genomes <- OikScrambling:::loadAllGenomes())
(reps <- OikScrambling:::loadAllRepeats())
(load("BreakPoints.Rdata"))
```

See `vignette("LoadGenomicBreaks", package = "OikScrambling")` for how the
different GBreaks objects are prepared.

# Repeats intersecting with GBreaks regions

## Compute

```{r repeat_annotations}
reps_in <- list()
Oki_pairs <- c("Oki_Osa", "Oki_Bar", "Oki_Kum", "Oki_Aom", "Oki_Nor")
Osa_pairs <- c("Osa_Oki", "Osa_Bar", "Osa_Kum", "Osa_Aom", "Osa_Nor")
Bar_pairs <- c("Bar_Oki", "Bar_Osa", "Bar_Kum", "Bar_Aom", "Bar_Nor")

mkRepsIn <- function(pairs, reps) {
  tableIntersectWithReps <- function(gb) {
    ov <- subsetByOverlaps(reps, gb, ignore.strand = TRUE)
    table(ov$Class)
  }
  reps_in <- list()
  reps_in$total   <- sapply(        pairs , \(.) table(reps$Class))
  reps_in$unal    <- sapply(unal   [pairs], tableIntersectWithReps)
  reps_in$gbs     <- sapply(gbs    [pairs], tableIntersectWithReps)
  reps_in$unmap   <- sapply(unmap  [pairs], tableIntersectWithReps)
  reps_in$unmap2  <- sapply(unmap2 [pairs], tableIntersectWithReps)
  reps_in$bri <- sapply(bri[pairs], tableIntersectWithReps)
  reps_in$map     <- sapply(coa    [pairs], tableIntersectWithReps)
  reps_in$map2    <- sapply(coa2   [pairs], tableIntersectWithReps)
  reps_in$tra     <- sapply(tra    [pairs], tableIntersectWithReps)
  reps_in
}

reps_in_Oki <- mkRepsIn(Oki_pairs, reps$Oki)
reps_in_Osa <- mkRepsIn(Osa_pairs, reps$Osa)
reps_in_Bar <- mkRepsIn(Bar_pairs, reps$Bar)

toLong <- function(m, Region = NULL) {
  m <- tibble::as_tibble(m, rownames = "Class") |>
    tidyr::pivot_longer(colnames(m))
  if (! is.null(Region))
    m <- dplyr::mutate(m, Region = Region)
  m
}

reps_in_Oki.norm <- lapply(reps_in_Oki, \(x) x / reps_in_Oki$total)
reps_in_Osa.norm <- lapply(reps_in_Osa, \(x) x / reps_in_Osa$total)
reps_in_Bar.norm <- lapply(reps_in_Bar, \(x) x / reps_in_Bar$total)


toLong.reps <- function(reps_in)
  rbind(
    toLong(reps_in$unmap,   "unMap"),
    toLong(reps_in$bri, "unAlnMap"),
    toLong(reps_in$map,     "Map"),
    toLong(reps_in$gbs,     "Aln"),
    toLong(reps_in$unal,    "unAln"),
    toLong(reps_in$tra,     "Tra")
  )

reps_in_Oki.long <- toLong.reps(reps_in_Oki)
reps_in_Osa.long <- toLong.reps(reps_in_Osa)
reps_in_Bar.long <- toLong.reps(reps_in_Bar)

reps_in_Oki.norm.long <- toLong.reps(reps_in_Oki.norm)
reps_in_Osa.norm.long <- toLong.reps(reps_in_Osa.norm)
reps_in_Bar.norm.long <- toLong.reps(reps_in_Bar.norm)
```

## Summary numbers

```{r summary_numbers}
sapply(reps_in_Oki.norm, rowMeans)
sapply(reps_in_Osa.norm, rowMeans)
sapply(reps_in_Bar.norm, rowMeans)
```

## Summary plots

Note that Oki has more repeat classes.

```{r summary_plots, fig.width=10}
# Here, the outlier is the same-species comparison, Okinawa – Kume
ggplot(reps_in_Oki.long) + aes(Region, value) +
  geom_boxplot() + geom_point(aes(col = name)) +
  facet_grid(~Class, scales = "free") + coord_flip()

# There, the outliers are the same-species comparison, Bar – Nor and Osa – Aom.
ggplot(rbind(reps_in_Osa.long, reps_in_Bar.long)) + aes(Region, value) +
  geom_boxplot() + geom_point(aes(col = name)) +
  facet_grid(~Class, scales = "free") + coord_flip()

# Summary plot combining all comparisons
ggplot(rbind(
  reps_in_Oki.norm.long,
  reps_in_Osa.norm.long,
  reps_in_Bar.norm.long
  ) |> dplyr::mutate(Distance = OikScrambling:::compDistance(name))) +
  aes(x="", value) + xlab("") + 
  geom_boxplot() + geom_point(aes(col = Distance)) +
  facet_grid(~Class ~Region, scales = "free") + coord_flip() +
  ylab("Fraction overlaping") +
  ggtitle("Repeats overlaping with computed regions")
```

# Tracking repeats across genome pairs

The [upset](https://vcg.github.io/upset/) plots below show whether a repeat
in the Okinawa or the Osaka genome as _target_ genome is located in an given
region in respect to one or many of the _query_ genomes.

*Note:* Some repeat annotations overlap.

## Aligned

More than 10,000 repeat annotations are in regions aligned to the
same-population control genome, demonstrating that they are mapable in principle.

```{r upset_plot_align}
isPresent <- function(r, gb) ifelse(countOverlaps(r,gb) == 0, 0, 1)

alignedRepsOki <- data.frame(
  align_Osa = isPresent(reps$Oki, gbs$Oki_Osa),
  align_Aom = isPresent(reps$Oki, gbs$Oki_Aom),
  align_Bar = isPresent(reps$Oki, gbs$Oki_Bar),
  align_Nor = isPresent(reps$Oki, gbs$Oki_Nor),
  align_Kum = isPresent(reps$Oki, gbs$Oki_Kum)
)
UpSetR::upset(alignedRepsOki)

alignedRepsOsa <- data.frame(
  align_Oki = isPresent(reps$Osa, gbs$Osa_Oki),
  align_Bar = isPresent(reps$Osa, gbs$Osa_Bar),
  align_Nor = isPresent(reps$Osa, gbs$Osa_Nor),
  align_Kum = isPresent(reps$Osa, gbs$Osa_Kum),
  align_Aom = isPresent(reps$Osa, gbs$Osa_Aom)
)
UpSetR::upset(alignedRepsOsa)

alignedRepsBar <- data.frame(
  align_Oki = isPresent(reps$Bar, gbs$Bar_Oki),
  align_Osa = isPresent(reps$Bar, gbs$Bar_Osa),
  align_Nor = isPresent(reps$Bar, gbs$Bar_Nor),
  align_Kum = isPresent(reps$Bar, gbs$Bar_Kum),
  align_Aom = isPresent(reps$Bar, gbs$Bar_Aom)
)
UpSetR::upset(alignedRepsBar)
```

## Unaligned

~40,000 repeat annotations are in regions that are not aligned to a
different-population_query_ genome.  This might be caused by insertions and
deletions.

```{r upset_plot_unal}
unalignedRepsOki <- data.frame(
  unal_Osa = isPresent(reps$Oki, unal$Oki_Osa),
  unal_Aom = isPresent(reps$Oki, unal$Oki_Aom),
  unal_Bar = isPresent(reps$Oki, unal$Oki_Bar),
  unal_Nor = isPresent(reps$Oki, unal$Oki_Nor),
  unal_Kum = isPresent(reps$Oki, unal$Oki_Kum)
)
UpSetR::upset(unalignedRepsOki)

unalignedRepsOsa <- data.frame(
  unal_Oki = isPresent(reps$Osa, unal$Osa_Oki),
  unal_Bar = isPresent(reps$Osa, unal$Osa_Bar),
  unal_Nor = isPresent(reps$Osa, unal$Osa_Nor),
  unal_Kum = isPresent(reps$Osa, unal$Osa_Kum),
  unal_Aom = isPresent(reps$Osa, unal$Osa_Aom)
)
UpSetR::upset(unalignedRepsOsa)

alignedRepsBar <- data.frame(
  unal_Oki = isPresent(reps$Bar, unal$Bar_Oki),
  unal_Osa = isPresent(reps$Bar, unal$Bar_Osa),
  unal_Nor = isPresent(reps$Bar, unal$Bar_Nor),
  unal_Kum = isPresent(reps$Bar, unal$Bar_Kum),
  unal_Aom = isPresent(reps$Bar, unal$Bar_Aom)
)
UpSetR::upset(alignedRepsBar)
```

## Mapped

```{r upset_plot_mapped}
mappedRepsOki <- data.frame(
  mapped_Osa = isPresent(reps$Oki, coa$Oki_Osa),
  mapped_Aom = isPresent(reps$Oki, coa$Oki_Aom),
  mapped_Bar = isPresent(reps$Oki, coa$Oki_Bar),
  mapped_Nor = isPresent(reps$Oki, coa$Oki_Nor),
  mapped_Kum = isPresent(reps$Oki, coa$Oki_Kum)
)
UpSetR::upset(mappedRepsOki)

mappedRepsOsa <- data.frame(
  mapped_Oki = isPresent(reps$Osa, coa$Osa_Oki),
  mapped_Bar = isPresent(reps$Osa, coa$Osa_Bar),
  mapped_Nor = isPresent(reps$Osa, coa$Osa_Nor),
  mapped_Kum = isPresent(reps$Osa, coa$Osa_Kum),
  mapped_Aom = isPresent(reps$Osa, coa$Osa_Aom)
)
UpSetR::upset(mappedRepsOsa)

mappedRepsBar <- data.frame(
  mapped_Oki = isPresent(reps$Bar, coa$Bar_Oki),
  mapped_Osa = isPresent(reps$Bar, coa$Bar_Osa),
  mapped_Nor = isPresent(reps$Bar, coa$Bar_Nor),
  mapped_Kum = isPresent(reps$Bar, coa$Bar_Kum),
  mapped_Aom = isPresent(reps$Bar, coa$Bar_Aom)
)
UpSetR::upset(mappedRepsBar)
```

## Unmapped

```{r upset_plot_unmapped}
unmappedRepsOki <- data.frame(
  unmapped_Osa = isPresent(reps$Oki, unmap$Oki_Osa),
  unmapped_Aom = isPresent(reps$Oki, unmap$Oki_Aom),
  unmapped_Bar = isPresent(reps$Oki, unmap$Oki_Bar),
  unmapped_Nor = isPresent(reps$Oki, unmap$Oki_Nor),
  unmapped_Kum = isPresent(reps$Oki, unmap$Oki_Kum)
)
UpSetR::upset(unmappedRepsOki)

unmappedRepsOsa <- data.frame(
  unmapped_Oki = isPresent(reps$Osa, unmap$Osa_Oki),
  unmapped_Bar = isPresent(reps$Osa, unmap$Osa_Bar),
  unmapped_Nor = isPresent(reps$Osa, unmap$Osa_Nor),
  unmapped_Kum = isPresent(reps$Osa, unmap$Osa_Kum),
  unmapped_Aom = isPresent(reps$Osa, unmap$Osa_Aom)
)
UpSetR::upset(unmappedRepsOsa)

unmappedRepsBar <- data.frame(
  unmapped_Oki = isPresent(reps$Bar, unmap$Bar_Oki),
  unmapped_Osa = isPresent(reps$Bar, unmap$Bar_Osa),
  unmapped_Nor = isPresent(reps$Bar, unmap$Bar_Nor),
  unmapped_Kum = isPresent(reps$Bar, unmap$Bar_Kum),
  unmapped_Aom = isPresent(reps$Bar, unmap$Bar_Aom)
)
UpSetR::upset(unmappedRepsBar)
```

## Unaligned but mapped by flanking colinear blocks

```{r upset_plot_bri}
briRepsOki <- data.frame(
  bri_Osa = isPresent(reps$Oki, bri$Oki_Osa),
  bri_Aom = isPresent(reps$Oki, bri$Oki_Aom),
  bri_Bar = isPresent(reps$Oki, bri$Oki_Bar),
  bri_Nor = isPresent(reps$Oki, bri$Oki_Nor),
  bri_Kum = isPresent(reps$Oki, bri$Oki_Kum)
)
UpSetR::upset(briRepsOki)

briRepsOsa <- data.frame(
  bri_Oki = isPresent(reps$Osa, bri$Osa_Oki),
  bri_Bar = isPresent(reps$Osa, bri$Osa_Bar),
  bri_Nor = isPresent(reps$Osa, bri$Osa_Nor),
  bri_Kum = isPresent(reps$Osa, bri$Osa_Kum),
  bri_Aom = isPresent(reps$Osa, bri$Osa_Aom)
)
UpSetR::upset(briRepsOsa)

briRepsBar <- data.frame(
  bri_Oki = isPresent(reps$Bar, bri$Bar_Oki),
  bri_Osa = isPresent(reps$Bar, bri$Bar_Osa),
  bri_Nor = isPresent(reps$Bar, bri$Bar_Nor),
  bri_Kum = isPresent(reps$Bar, bri$Bar_Kum),
  bri_Aom = isPresent(reps$Bar, bri$Bar_Aom)
)
UpSetR::upset(briRepsBar)
```

## Transposed

```{r upset_plot_tra}
traRepsOki <- data.frame(
  tra_Osa = isPresent(reps$Oki, tra$Oki_Osa),
  tra_Aom = isPresent(reps$Oki, tra$Oki_Aom),
  tra_Bar = isPresent(reps$Oki, tra$Oki_Bar),
  tra_Nor = isPresent(reps$Oki, tra$Oki_Nor),
  tra_Kum = isPresent(reps$Oki, tra$Oki_Kum)
)
UpSetR::upset(traRepsOki)

traRepsOsa <- data.frame(
  tra_Oki = isPresent(reps$Osa, tra$Osa_Oki),
  tra_Bar = isPresent(reps$Osa, tra$Osa_Bar),
  tra_Nor = isPresent(reps$Osa, tra$Osa_Nor),
  tra_Kum = isPresent(reps$Osa, tra$Osa_Kum),
  tra_Aom = isPresent(reps$Osa, tra$Osa_Aom)
)
UpSetR::upset(traRepsOsa)

traRepsBar <- data.frame(
  tra_Oki = isPresent(reps$Bar, tra$Bar_Oki),
  tra_Osa = isPresent(reps$Bar, tra$Bar_Osa),
  tra_Nor = isPresent(reps$Bar, tra$Bar_Nor),
  tra_Kum = isPresent(reps$Bar, tra$Bar_Kum),
  tra_Aom = isPresent(reps$Bar, tra$Bar_Aom)
)
UpSetR::upset(traRepsBar)
```


# Repeat annotation of the GBreaks objects

See `vignette("LoadGenomicBreaks", package = "OikScrambling")` for how the
different GBreaks objects are annotated.

```{r gbreaks_annot}
countGbsMatchingReps <- function(gb)  sum(sapply(gb$rep, \(x) ! any(is.na(x))))
 fracGbsMatchingReps <- function(gbl) sapply(gbl, countGbsMatchingReps) / sapply(gbl, length)

summaryMatchingReps <- (sapply(list(aligned    = gbs[1:15],     unAligned = unal[1:15],
             mapped     = coa[1:15],     unMapped  = unmap[1:15],
             unAlMapped = bri[1:15],
             transposed = tra[1:15],     transposed2 = tra2[1:15],
             mapped2    = coa2[1:15],    unMapped2 = unmap2[1:15]),
        fracGbsMatchingReps))

summaryMatchingReps |> tibble::as_tibble() |>
  dplyr::group_by(dist=rownames(summaryMatchingReps) |> OikScrambling:::compDistance()) |>
  dplyr::summarise_all(mean)

```

# Reduced repeat set

Old plots; they show that the above is also true if we merge overlapping repeats.

```{r}
reps.reduced <- sapply(reps, reduce, ignore.strand = TRUE) |> SimpleList()
# They are short.
sapply(reps.reduced, \(gr) summary(width(gr)))
```

# Colinearity interruptors (unmapped regions ?)

```{r unaligned_regions2}
(reps_coa <- tibble::tibble(
    pairname    = Oki_pairs,
    total       = length(reps.reduced$Oki),
    match_unmap = sapply(unmap[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    match_map   = sapply(   coa[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    mapped      = match_map   / total * 100,
    unmapped    = match_unmap / total * 100,
    sum = mapped + unmapped
))

ggplot(reps_coa |> tidyr::pivot_longer(c("mapped", "unmapped"))) +
  aes(name, value) +
  ggtitle("Matches of repeats to mapped or unmaped regions") +
  scale_y_continuous(limits = c(0, 100)) +
  ylab("Percent of the repeat regions") +
  xlab("Matching to region:") +
  geom_boxplot() +
  geom_point(aes(col = pairname))
```

# Unaligned regions

```{r unaligned_regions}
(reps_gbs <- tibble::tibble(
    pairname   = Oki_pairs,
    total      = length(reps.reduced$Oki),
    match_unal = sapply(unal[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    match_al   = sapply(gbs[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    aligned   = match_al   / total * 100,
    unaligned = match_unal / total * 100,
    sum = aligned + unaligned
))

ggplot(reps_gbs |> tidyr::pivot_longer(c("aligned", "unaligned"))) +
  aes(name, value) +
  ggtitle("Matches of repeats to aligned or unaligned regions") +
  scale_y_continuous(limits = c(0, 100)) +
  ylab("Percent of the repeat regions") +
  xlab("Matching to region:") +
  geom_boxplot() +
  geom_point(aes(col = pairname))
```

# Repeat annotation of the shortest mapped regions

In Oki – North comparisons, the distribution of mapped region widths is bimodal
and the two peaks are best separated around 600 bp.  See
`vignette("RegionWidths", package = "OikScrambling")` for details.

```{r example_width_dist_for_oki_osa}
coa$Oki_Osa |> plyranges::mutate(w_short = width < 600) |> as.data.frame() |> tibble::as_tibble() |>
  ggplot() + aes(width, col =Arm) +
  geom_freqpoly() + scale_x_log10() +
  geom_vline(xintercept = 600) +
  ggtitle("Example width distribution of mapped regions (Oki_Osa)")
```

We want to know if the regions of width shorter than 600 match more repeats, and
to what extent the matching repeats cover them.

```{r}
checkOverlapWithRepeatsInShortAndLongWidthRegions <- function(gr, rep) {
  grl <- gr |> split(width(gr) < 600)
  tibble::tibble(
    `Length`                   = c(Long = "Long", Short = "Short"),
    `Number of regions`        = c(Long  = length(grl[["FALSE"]]),
                                 Short = length(grl[["TRUE"]])),
    `Total width`              = c(Long  = grl[["FALSE"]] |> reduce() |> width() |> sum(),
                                 Short = grl[["TRUE"]]  |> reduce() |> width() |> sum()),
    `Width covered by reps`    = c(Long  = intersect(grl[["FALSE"]], rep) |> reduce() |> width() |> sum(),
                                 Short = intersect(grl[["TRUE"]], rep)  |> reduce() |> width() |> sum())
  )
}
checkOverlapWithRepeatsInShortAndLongWidthRegions(coa$Oki_Osa, reps$Oki)
checkOverlapWithRepeatsInShortAndLongWidthRegions(coa$Osa_Oki, reps$Osa)
checkOverlapWithRepeatsInShortAndLongWidthRegions(coa$Bar_Oki, reps$Bar)
```

In conclusion, most of the short mapped regions are not mapped repeats.
