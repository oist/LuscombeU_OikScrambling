---
title: "Repeat regions"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Repeat regions}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(cache = TRUE, cache.lazy = FALSE)
knitr::opts_knit$set(verbose = TRUE)
```

# Introduction

Regions matching repeat annotations in the _target_ or the _query_ genome.

# Load R pacakges and data

```{r load_packages_and_data}
library('OikScrambling') |> suppressPackageStartupMessages()
(genomes <- OikScrambling:::loadAllGenomes())
(annots <- OikScrambling:::loadAllAnnotations() |> suppressWarnings())
(reps <- OikScrambling:::loadAllRepeats())
(load("BreakPoints.Rdata"))
```

See `vignette("LoadGenomicBreaks", package = "OikSyntenies")` for how the
different GBreaks objects are prepared.

# Repeat

```{r repeat_annotations}
reps_in <- list()
Oki_pairs <- c("Oki_Osa", "Oki_Bar", "Oki_Kum", "Oki_Aom", "Oki_Nor")
Osa_pairs <- c("Osa_Oki", "Osa_Bar", "Osa_Kum", "Osa_Aom", "Osa_Nor")
Bar_pairs <- c("Bar_Oki", "Bar_Osa", "Bar_Kum", "Bar_Aom", "Bar_Nor")

mkRepsIn <- function(pairs, reps) {
  tableIntersectWithReps <- function(gb) {
    ov <- subsetByOverlaps(reps, gb, ignore.strand = TRUE)
    table(ov$Class)
  }
  reps_in <- list()
  reps_in$total   <- sapply(        pairs , \(.) table(reps$Class))
  reps_in$unal    <- sapply(unal   [pairs], tableIntersectWithReps)
  reps_in$gbs     <- sapply(gbs    [pairs], tableIntersectWithReps)
  reps_in$unmap   <- sapply(unmap  [pairs], tableIntersectWithReps)
  reps_in$unalMap <- sapply(unalMap[pairs], tableIntersectWithReps)
  reps_in$map     <- sapply(coa    [pairs], tableIntersectWithReps)
  reps_in
}

reps_in_Oki <- mkRepsIn(Oki_pairs, reps$Oki)
reps_in_Osa <- mkRepsIn(Osa_pairs, reps$Osa)
reps_in_Bar <- mkRepsIn(Bar_pairs, reps$Bar)

toLong <- function(m, Region = NULL) {
  m <- tibble::as_tibble(m, rownames = "Class") |>
    tidyr::pivot_longer(colnames(m))
  if (! is.null(Region))
    m <- dplyr::mutate(m, Region = Region)
  m
}

reps_in_Oki.norm <- lapply(reps_in_Oki, \(x) x / reps_in_Oki$total)
reps_in_Osa.norm <- lapply(reps_in_Osa, \(x) x / reps_in_Osa$total)

toLong.reps <- function(reps_in)
  rbind(
    toLong(reps_in$unmap,   "unmap"),
    toLong(reps_in$unalMap, "unalMap"),
    toLong(reps_in$map,     "map"),
    toLong(reps_in$gbs,     "gbs"),
    toLong(reps_in$unal,    "unal")
  )

reps_in_Oki.long <- toLong.reps(reps_in_Oki)
reps_in_Osa.long <- toLong.reps(reps_in_Osa)

reps_in_Oki.norm.long <- toLong.reps(reps_in_Oki.norm)
reps_in_Osa.norm.long <- toLong.reps(reps_in_Osa.norm)

ggplot(reps_in_Oki.long) +
  aes(Region, value) +
  geom_point(aes(col = name)) +
  facet_grid(~Class, scales = "free")

ggplot(reps_in_Osa.long) +
  aes(Region, value) +
  geom_point(aes(col = name)) +
  facet_grid(~Class, scales = "free")

ggplot(reps_in_Oki.norm.long) +
  aes(Region, value) +
  geom_point(aes(col = name)) +
  facet_grid(~Class, scales = "free") +
  ylab("Fraction overlaping") +
  ggtitle("Repeats overlaping with (un)aligned/mapped regions (Oki)")

ggplot(reps_in_Osa.norm.long) +
  aes(Region, value) +
  geom_point(aes(col = name)) +
  facet_grid(~Class, scales = "free") +
  ylab("Fraction overlaping") +
  ggtitle("Repeats overlaping with (un)aligned/mapped regions (Osa)")
```

# Tracking repeats across genome pairs

The [upset](https://vcg.github.io/upset/) plots below show whether a repeat
in the Okinawa or the Osaka genome as _target_ genome is located in an given
region in respect to one or many of the _query_ genomes.

*Note:* Some repeat annotations overlap.

## Aligned

More than 10,000 repeat annotations are in regions aligned to the
same-population control genome, demonstrating that they are mapable in principle.

```{r upset_plot_align}
isPresent <- function(r, gb) ifelse(countOverlaps(r,gb) == 0, 0, 1)

alignedRepsOki <- data.frame(
  align_Osa = isPresent(reps$Oki, gbs$Oki_Osa),
  align_Aom = isPresent(reps$Oki, gbs$Oki_Aom),
  align_Bar = isPresent(reps$Oki, gbs$Oki_Bar),
  align_Nor = isPresent(reps$Oki, gbs$Oki_Nor),
  align_Kum = isPresent(reps$Oki, gbs$Oki_Kum)
)
UpSetR::upset(alignedRepsOki)

alignedRepsOsa <- data.frame(
  align_Oki = isPresent(reps$Osa, gbs$Osa_Oki),
  align_Bar = isPresent(reps$Osa, gbs$Osa_Bar),
  align_Nor = isPresent(reps$Osa, gbs$Osa_Nor),
  align_Kum = isPresent(reps$Osa, gbs$Osa_Kum),
  align_Aom = isPresent(reps$Osa, gbs$Osa_Aom)
)
UpSetR::upset(alignedRepsOsa)
```

## Unaligned

~40,000 repeat annotations are in regions that are not aligned to a
different-population_query_ genome.  This might be caused by insertions and
deletions.

```{r upset_plot_unal}
unalignedRepsOki <- data.frame(
  unal_Osa = isPresent(reps$Oki, unal$Oki_Osa),
  unal_Aom = isPresent(reps$Oki, unal$Oki_Aom),
  unal_Bar = isPresent(reps$Oki, unal$Oki_Bar),
  unal_Nor = isPresent(reps$Oki, unal$Oki_Nor),
  unal_Kum = isPresent(reps$Oki, unal$Oki_Kum)
)
UpSetR::upset(unalignedRepsOki)

unalignedRepsOsa <- data.frame(
  unal_Oki = isPresent(reps$Osa, unal$Osa_Oki),
  unal_Bar = isPresent(reps$Osa, unal$Osa_Bar),
  unal_Nor = isPresent(reps$Osa, unal$Osa_Nor),
  unal_Kum = isPresent(reps$Osa, unal$Osa_Kum),
  unal_Aom = isPresent(reps$Osa, unal$Osa_Aom)
)
UpSetR::upset(unalignedRepsOsa)
```

## Mapped

```{r upset_plot_mapped}
mappedRepsOki <- data.frame(
  mapped_Osa = isPresent(reps$Oki, coa$Oki_Osa),
  mapped_Aom = isPresent(reps$Oki, coa$Oki_Aom),
  mapped_Bar = isPresent(reps$Oki, coa$Oki_Bar),
  mapped_Nor = isPresent(reps$Oki, coa$Oki_Nor),
  mapped_Kum = isPresent(reps$Oki, coa$Oki_Kum)
)
UpSetR::upset(mappedRepsOki)

mappedRepsOsa <- data.frame(
  mapped_Oki = isPresent(reps$Osa, coa$Osa_Oki),
  mapped_Bar = isPresent(reps$Osa, coa$Osa_Bar),
  mapped_Nor = isPresent(reps$Osa, coa$Osa_Nor),
  mapped_Kum = isPresent(reps$Osa, coa$Osa_Kum),
  mapped_Aom = isPresent(reps$Osa, coa$Osa_Aom)
)
UpSetR::upset(mappedRepsOsa)
```

## Unmapped

```{r upset_plot_unmapped}
unmappedRepsOki <- data.frame(
  unmapped_Osa = isPresent(reps$Oki, unmap$Oki_Osa),
  unmapped_Aom = isPresent(reps$Oki, unmap$Oki_Aom),
  unmapped_Bar = isPresent(reps$Oki, unmap$Oki_Bar),
  unmapped_Nor = isPresent(reps$Oki, unmap$Oki_Nor),
  unmapped_Kum = isPresent(reps$Oki, unmap$Oki_Kum)
)
UpSetR::upset(unmappedRepsOki)

unmappedRepsOsa <- data.frame(
  unmapped_Oki = isPresent(reps$Osa, unmap$Osa_Oki),
  unmapped_Bar = isPresent(reps$Osa, unmap$Osa_Bar),
  unmapped_Nor = isPresent(reps$Osa, unmap$Osa_Nor),
  unmapped_Kum = isPresent(reps$Osa, unmap$Osa_Kum),
  unmapped_Aom = isPresent(reps$Osa, unmap$Osa_Aom)
)
UpSetR::upset(unmappedRepsOsa)
```

## Unaligned but mapped by flanking colinear blocks

```{r upset_plot_unalMap}
unalMapRepsOki <- data.frame(
  unalMap_Osa = isPresent(reps$Oki, unalMap$Oki_Osa),
  unalMap_Aom = isPresent(reps$Oki, unalMap$Oki_Aom),
  unalMap_Bar = isPresent(reps$Oki, unalMap$Oki_Bar),
  unalMap_Nor = isPresent(reps$Oki, unalMap$Oki_Nor),
  unalMap_Kum = isPresent(reps$Oki, unalMap$Oki_Kum)
)
UpSetR::upset(unalMapRepsOki)

unalMapRepsOsa <- data.frame(
  unalMap_Oki = isPresent(reps$Osa, unalMap$Osa_Oki),
  unalMap_Bar = isPresent(reps$Osa, unalMap$Osa_Bar),
  unalMap_Nor = isPresent(reps$Osa, unalMap$Osa_Nor),
  unalMap_Kum = isPresent(reps$Osa, unalMap$Osa_Kum),
  unalMap_Aom = isPresent(reps$Osa, unalMap$Osa_Aom)
)
UpSetR::upset(unalMapRepsOsa)
```

# Reduced repeat set

```{r}
reps.reduced <- sapply(reps, reduce, ignore.strand = TRUE) |> SimpleList()
# They are short.
sapply(reps.reduced, \(gr) summary(width(gr)))
```

# Colinearity interruptors (unmapped regions ?)

```{r unaligned_regions2}
(reps_coa <- tibble::tibble(
    pairname    = Oki_pairs,
    total       = length(reps.reduced$Oki),
    match_unmap = sapply(unmap[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    match_map   = sapply(   coa[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    mapped      = match_map   / total * 100,
    unmapped    = match_unmap / total * 100,
    sum = mapped + unmapped
))

ggplot(reps_coa |> tidyr::pivot_longer(c("mapped", "unmapped"))) +
  aes(name, value) +
  ggtitle("Matches of repeats to mapped or unmaped regions") +
  scale_y_continuous(limits = c(0, 100)) +
  ylab("Percent of the repeat regions") +
  xlab("Matching to region:") +
  geom_boxplot() +
  geom_point(aes(col = pairname))
```

# Unaligned regions

```{r unaligned_regions}
(reps_gbs <- tibble::tibble(
    pairname   = Oki_pairs,
    total      = length(reps.reduced$Oki),
    match_unal = sapply(unal[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    match_al   = sapply(gbs[Oki_pairs], \(gb) length(subsetByOverlaps(reps.reduced$Oki, gb))),
    aligned   = match_al   / total * 100,
    unaligned = match_unal / total * 100,
    sum = aligned + unaligned
))

ggplot(reps_gbs |> tidyr::pivot_longer(c("aligned", "unaligned"))) +
  aes(name, value) +
  ggtitle("Matches of repeats to aligned or unaligned regions") +
  scale_y_continuous(limits = c(0, 100)) +
  ylab("Percent of the repeat regions") +
  xlab("Matching to region:") +
  geom_boxplot() +
  geom_point(aes(col = pairname))
```
