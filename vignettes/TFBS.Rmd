---
title: "Transcription factor binding sites"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Transcription factor binding sites}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup2}
library("GenomicBreaks")
genomes     <- OikScrambling:::loadAllGenomes()
```

```{r load_TFBS}
library(TFBSTools)
library(JASPAR2020)
PFMatrixList <- getMatrixSet(JASPAR2020, list(tax_group="vertebrates"))
PFMatrixList
PWMatrixList <- toPWM(PFMatrixList)
```

```{r scan_TFBS}
TFBS <- SimpleList()
Oki_DNAStringSet <- lapply(seqnames(genomes$Oki), \(name) genomes$Oki[[name]]) |> as("DNAStringSet")
names(Oki_DNAStringSet) <- seqnames(genomes$Oki)

searchSeq2GB <- function(pwm, genomeseqs, mc.cores=1L) {
  siteSet <- TFBSTools::searchSeq(pwm, genomeseqs, mc.cores = mc.cores) |> suppressWarnings()
  gr <- as(siteSet, "GRanges")
  # Slim the result object
  gr$siteSeqs <- NULL
  # Most PWMs are palindromic, so strand information has little relevance but
  # bloats the object with redundant copies
  strand(gr) <- '*'
  unique(sort(gr, ignore.strand=TRUE))
}
siteSet <- searchSeq2GB(PWMatrixList[1], Oki_DNAStringSet)
pwmMatchesOnOki <- lapply(PWMatrixList[1:20] |> as.list(), searchSeq2GB, Oki_DNAStringSet, mc.cores=4L)
```
