---
title: "Transcription factor binding sites"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Transcription factor binding sites}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We skip all computations if `pwmMatchesOki.Rds`, because it is heavy.

```{r setup2}
if (! file.exists("pwmMatchesOki.Rds")) {
library("GenomicBreaks")
genomes     <- OikScrambling:::loadAllGenomes()
}
```

Select all vertebrate entries; convert to a list of position-weight matrices.

```{r load_TFBS}
if (! file.exists("pwmMatchesOki.Rds")) {
library(TFBSTools)
library(JASPAR2020)
PFMatrixList <- getMatrixSet(JASPAR2020, list(tax_group="vertebrates"))
PFMatrixList
PWMatrixList <- toPWM(PFMatrixList)
}
```

Scan the Okinawa genome, save the results and save a reduced version for the
Gen

```{r scan_TFBS}
if (! file.exists("pwmMatchesOki.Rds")) {

Oki_DNAStringSet <- lapply(seqnames(genomes$Oki), \(name) genomes$Oki[[name]]) |> as("DNAStringSet")
names(Oki_DNAStringSet) <- seqnames(genomes$Oki)

searchSeq2GB <- function(pwm, genomeseqs, mc.cores=1L) {
  siteSet <- TFBSTools::searchSeq(pwm, genomeseqs, mc.cores = mc.cores) |> suppressWarnings()
  gr <- as(siteSet, "GRanges")
  # Slim the result object
  gr$siteSeqs <- NULL
  # Most PWMs are palindromic, so strand information has little relevance but
  # bloats the object with redundant copies
  strand(gr) <- '*'
  unique(sort(gr, ignore.strand=TRUE))
}

pwmMatchesOnOki <- lapply(PWMatrixList |> as.list(), searchSeq2GB, Oki_DNAStringSet)
# x_15_98 <- lapply(pwmMatchesOnOki, \(gr) gr[gr$relScore > 0.98 & gr$absScore > 15]) |> as("GRangesList") |> unlist() |> reduce()
# x_10_95 <- lapply(pwmMatchesOnOki, \(gr) gr[gr$relScore > 0.95 & gr$absScore > 10]) |> as("GRangesList") |> unlist() |> reduce()
# x_15_95 <- lapply(pwmMatchesOnOki, \(gr) gr[gr$relScore > 0.95 & gr$absScore > 15]) |> as("GRangesList") |> unlist() |> reduce()
# x_12_90 <- lapply(pwmMatchesOnOki, \(gr) gr[gr$relScore > 0.90 & gr$absScore > 12]) |> as("GRangesList") |> unlist() |> reduce()
# x_15_90 <- lapply(pwmMatchesOnOki, \(gr) gr[gr$relScore > 0.90 & gr$absScore > 15]) |> as("GRangesList") |> unlist() |> reduce()
# Selected this one as a compromise between lower baseline and visible peaks.
pwmMatchesOnOki_12_95 <- lapply(pwmMatchesOnOki, \(gr) gr[gr$relScore > 0.95 & gr$absScore > 12]) |> as("GRangesList") |> unlist() |> reduce()
# x_10_99 <- lapply(pwmMatchesOnOki, \(gr) gr[gr$relScore > 0.99 & gr$absScore > 10]) |> as("GRangesList") |> unlist() |> reduce()

saveRDS(pwmMatchesOnOki,       "pwmMatchesOki.Rds")
saveRDS(pwmMatchesOnOki_12_95, "pwmMatchesOki_12_95.Rds")
}
```


```{r scan_TFBS_osa}
if (! file.exists("pwmMatchesOsa.Rds")) {
library("GenomicBreaks")
genomes <- OikScrambling:::loadAllGenomes()
library(TFBSTools)
library(JASPAR2020)

Osa_DNAStringSet <- lapply(seqnames(genomes$Osa), \(name) genomes$Osa[[name]]) |> as("DNAStringSet")
names(Osa_DNAStringSet) <- seqnames(genomes$Osa)

pwmMatchesOnOsa <- lapply(PWMatrixList |> as.list(), searchSeq2GB, Osa_DNAStringSet)
# x_15_98 <- lapply(pwmMatchesOnOsa, \(gr) gr[gr$relScore > 0.98 & gr$absScore > 15]) |> as("GRangesList") |> unlist() |> reduce()
# x_10_95 <- lapply(pwmMatchesOnOsa, \(gr) gr[gr$relScore > 0.95 & gr$absScore > 10]) |> as("GRangesList") |> unlist() |> reduce()
# x_15_95 <- lapply(pwmMatchesOnOsa, \(gr) gr[gr$relScore > 0.95 & gr$absScore > 15]) |> as("GRangesList") |> unlist() |> reduce()
# x_12_90 <- lapply(pwmMatchesOnOsa, \(gr) gr[gr$relScore > 0.90 & gr$absScore > 12]) |> as("GRangesList") |> unlist() |> reduce()
# x_15_90 <- lapply(pwmMatchesOnOsa, \(gr) gr[gr$relScore > 0.90 & gr$absScore > 15]) |> as("GRangesList") |> unlist() |> reduce()
# Selected this one as a compromise between lower baseline and visible peaks.
pwmMatchesOnOsa_12_95 <- lapply(pwmMatchesOnOsa, \(gr) gr[gr$relScore > 0.95 & gr$absScore > 12]) |> as("GRangesList") |> unlist() |> reduce()
# x_10_99 <- lapply(pwmMatchesOnOsa, \(gr) gr[gr$relScore > 0.99 & gr$absScore > 10]) |> as("GRangesList") |> unlist() |> reduce()

saveRDS(pwmMatchesOnOsa,       "pwmMatchesOsa.Rds")
saveRDS(pwmMatchesOnOsa_12_95, "pwmMatchesOsa_12_95.Rds")
}

```
