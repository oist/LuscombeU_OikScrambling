---
title: "Exploring coding-sequence substitutions"
author: 
 - "Michael Mansfield"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploring coding-sequence substitutions}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup}
knitr::opts_knit$set(verbose = TRUE)
```

# Introduction

This vignette loads dN/dS statistics tables and explores the
relationship between substitutions in coding sequences and genomic
breaks.

This vignette assumes that prior vignettes have been explored by the
user previously and that the `GenomicBreaks` and `OikScrambling`
packages have been installed already.

# Packages and data

```{r load_pacakges_and_data}
suppressPackageStartupMessages({
  library("tibble")
  library("dplyr")
  library('GenomicBreaks')
  library('ggplot2')
  library("BreakpointsData")
})

(genomes <- OikScrambling:::loadAllGenomes())
(transcripts <- OikScrambling:::loadAllTranscriptsGR())

load("BreakPoints.Rdata")
```

# Genomic breaks


## dN/dS values

Once you have a fully-populated `GBreaks` object with all of the annotations you want,
adding additional metadata like dN/dS values is simple. First, load the dN/dS tables.

This yields a `SimpleList` `dNdS_GUIDANCE2`, which contains data frames organized by dN/dS method.
The data frames look like so:

By creating a `GBreaks` object with the metadata column `tx_name`, we can combine
this dN/dS dataframe using that shared key with the `addMetadataToGRanges` function.

The `GBreaks` object from the `OrthogroupSyntenies` vignette is suitable.

```{r create_dNdS_GUIDANCE2_orthopairs, fig.height=12, fig.width=8.5, dev=c('svg', 'png')}
orthoPairToGBreaks <- function(name1, name2, annot1, annot2) {
  orthoPairs <- load_one_to_ones(
    system.file("extdata/OrthoFinder/N19.tsv", package = "BreakpointsData"),
    c(name1, name2))

  IDs2GRanges <- function (IDs, annot) {
    prefix <- Biobase::lcPrefix(IDs)                  # Guess prefix in transcript IDs from HOG files
    not_prefix <- Biobase::lcPrefix(annot$tx_name)    # Remove trailing characters that are part of the name
    not_prefix <- paste0(not_prefix,"$")              # Anchor to end of the string
    prefix <- sub(not_prefix, "", prefix)             # Finalise prefix
    IDs <- sub(prefix, "", IDs)                       # Remove prefix from IDS
    names(annot) <- annot$tx_name                     # Store transcript name in names slot
    gr <- granges(annot[IDs], use.mcols=T)            # Don't! discard metadata. Sort by ID
    strand(gr) <- "*"                                 # Make strandless
    gr                                                # Return the object
  }
  
  gb       <- IDs2GRanges(orthoPairs[,name1], annot1)
  gb$query <- IDs2GRanges(orthoPairs[,name2], annot2)
  gb <- GenomicBreaks:::GBreaks(gb)
  sort(gb)
}

orthoPairs <- SimpleList()
orthoPairs$Oki_Osa <- orthoPairToGBreaks("OKI2018_I69.v2.prot.longest.fa_1", "OSKA2016v1.9.prot.longest.fa_1"
                                        , transcripts$Oki, transcripts$Osa)
orthoPairs$Oki_Bar <- orthoPairToGBreaks("OKI2018_I69.v2.prot.longest.fa_1", "Bar2_p4.Flye.prot.longest.fa_1"
                                        , transcripts$Oki, transcripts$Bar)
orthoPairs$Oki_Kum <- orthoPairToGBreaks("OKI2018_I69.v2.prot.longest.fa_1", "KUM-M3-7f.prot.longest.fa_1"
                                        , transcripts$Oki, transcripts$Kum)
orthoPairs$Oki_Aom <- orthoPairToGBreaks("OKI2018_I69.v2.prot.longest.fa_1", "AOM-5-5f.prot.longest.fa_1"
                                        , transcripts$Oki, transcripts$Aom)
orthoPairs$Oki_Nor <- orthoPairToGBreaks("OKI2018_I69.v2.prot.longest.fa_1", "OdB3.v1.0.prot.fa_1.nohaplo"
                                       , transcripts$Oki, transcripts$Nor)

orthoPairs$Osa_Bar <- orthoPairToGBreaks("OSKA2016v1.9.prot.longest.fa_1", "Bar2_p4.Flye.prot.longest.fa_1"
                                        , transcripts$Osa, transcripts$Bar)
orthoPairs$Osa_Oki <- orthoPairToGBreaks("OSKA2016v1.9.prot.longest.fa_1", "OKI2018_I69.v2.prot.longest.fa_1"
                                        , transcripts$Osa, transcripts$Oki)
orthoPairs$Osa_Kum <- orthoPairToGBreaks("OSKA2016v1.9.prot.longest.fa_1", "KUM-M3-7f.prot.longest.fa_1"
                                        , transcripts$Osa, transcripts$Kum)
orthoPairs$Osa_Aom <- orthoPairToGBreaks("OSKA2016v1.9.prot.longest.fa_1", "AOM-5-5f.prot.longest.fa_1"
                                        , transcripts$Osa, transcripts$Aom)
orthoPairs$Osa_Nor <- orthoPairToGBreaks("OSKA2016v1.9.prot.longest.fa_1", "OdB3.v1.0.prot.fa_1.nohaplo"
                                       , transcripts$Osa, transcripts$Nor)


orthoPairs$Bar_Osa <- orthoPairToGBreaks("Bar2_p4.Flye.prot.longest.fa_1", "OSKA2016v1.9.prot.longest.fa_1"
                                        , transcripts$Bar, transcripts$Osa)
orthoPairs$Bar_Oki <- orthoPairToGBreaks("Bar2_p4.Flye.prot.longest.fa_1", "OKI2018_I69.v2.prot.longest.fa_1"
                                        , transcripts$Bar, transcripts$Oki)
orthoPairs$Bar_Kum <- orthoPairToGBreaks("Bar2_p4.Flye.prot.longest.fa_1", "KUM-M3-7f.prot.longest.fa_1"
                                        , transcripts$Bar, transcripts$Kum)
orthoPairs$Bar_Aom <- orthoPairToGBreaks("Bar2_p4.Flye.prot.longest.fa_1", "AOM-5-5f.prot.longest.fa_1"
                                        , transcripts$Bar, transcripts$Aom)
orthoPairs$Bar_Nor <- orthoPairToGBreaks("Bar2_p4.Flye.prot.longest.fa_1", "OdB3.v1.0.prot.fa_1.nohaplo"
                                       , transcripts$Bar, transcripts$Nor)

orthoPairs[ 1:5 ] <- sapply(orthoPairs[ 1:5 ],  flagLongShort, longShort$Oki)
orthoPairs[ 6:10] <- sapply(orthoPairs[ 6:10],  flagLongShort, longShort$Osa)
orthoPairs[11:15] <- sapply(orthoPairs[11:15],  flagLongShort, longShort$Bar)
```

Using these transcript-based `GBreaks` objects, you can annotate those
transcripts with arbitrary metadata. Note that the transcript identifier
is relative to the target.

TODO resolve cases where query metadata is not precisely equal to target metadata

Now, we can get to plotting.

```{r plot_init_orthopairs_dNdS_GUIDANCE2}
ggplot(tibble(as.data.frame(orthoPairs$Oki_Osa))) +
  aes(dNdS_GUIDANCE2, fill=Arm) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~seqnames) +
  ggtitle('dN/dS by chromosome and chromosome arm for Oki/Osa')
```

Notice that an unplaced scaffold appears to have a gene that was used for the dN/dS analysis. Let's filter those out.

```{r plot_enumerate_dNdS_GUIDANCE2}
ggplot(tibble(as.data.frame(orthoPairs$Oki_Osa)) %>% filter(seqnames %in% c('chr1', 'chr2', 'PAR', 'XSR', 'YSR'))) +
  aes(dNdS_GUIDANCE2, fill=Arm) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~seqnames) +
  ggtitle('dN/dS by chromosome and chromosome arm for Oki/Osa')
```

Let's enumerate the rest:

```{r dNdS_GUIDANCE2_enumerate}
# Note that the chromosome names change.
ggplot(tibble(as.data.frame(orthoPairs$Osa_Oki)) %>% filter(seqnames %in% c('Chr1', 'Chr2', 'PAR', 'XSR', 'YSR'))) +
  aes(dNdS_GUIDANCE2, fill=Arm) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~seqnames) +
  ggtitle('dN/dS by chromosome and chromosome arm for Osa/Oki')
ggplot(tibble(as.data.frame(orthoPairs$Osa_Bar)) %>% filter(seqnames %in% c('Chr1', 'Chr2', 'PAR', 'XSR', 'YSR'))) +
  aes(dNdS_GUIDANCE2, fill=Arm) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~seqnames) +
  ggtitle('dN/dS by chromosome and chromosome arm for Osa/Bar')

ggplot(tibble(as.data.frame(orthoPairs$Bar_Osa)) %>% filter(seqnames %in% c('Chr1', 'Chr2', 'PAR', 'XSR', 'YSR'))) +
  aes(dNdS_GUIDANCE2, fill=Arm) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~seqnames) +
  ggtitle('dN/dS by chromosome and chromosome arm for Bar/Osa')

ggplot(tibble(as.data.frame(orthoPairs$Bar_Oki)) %>% filter(seqnames %in% c('Chr1', 'Chr2', 'PAR', 'XSR', 'YSR'))) +
  aes(dNdS_GUIDANCE2, fill=Arm) +
  geom_boxplot() +
  coord_flip() +
  facet_wrap(~seqnames) +
  ggtitle('dN/dS by chromosome and chromosome arm for Bar/Oki')
```

# Session information

```{r session_info}
sessionInfo()
```
