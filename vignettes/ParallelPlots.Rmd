---
title: "Whole-chromosome parallel plots"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Whole-chromosome parallel plots}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(cache = TRUE, cache.lazy = FALSE)
knitr::opts_knit$set(verbose = TRUE)
```

# Introduction

In this vignette I plot whole chromosomes in parallel to reflect synteny and
the difference of scrambling between short and long arms.

The core functions used here are maintained in our _GenomicBreaks_ R package,
which is fully documented at: <https://oist.github.io/GenomicBreaks>.

## Load pacakges

# Load R pacakges and data

```{r load_packages_and_data}
library('OikScrambling') |> suppressPackageStartupMessages()
(genomes <- OikScrambling:::loadAllGenomes())
(load("BreakPoints.Rdata"))
```

### Phylogenetic cladogram

We assume that the _North Pacific_ and the _Atlantic_ species are more related
to each other than to the _Okinawan_ species.

```{r phylogenetic_tree, fig.height=4, fig.width=6, dev="svg"}
requireNamespace("ade4")
treeLeaf <- function(name, length=NULL) {
  if(!is.null(length)) length <- paste0(':', length)
  paste0(name, length)
}

treeNode <- function(branch1, branch2, length = NULL) {
  if(!is.null(length)) length <- paste0(':', length)
  paste0('(', branch1, ',', branch2, ')', length)
}

addRoot <- function(branch)  paste0(branch, ";")

tree <-
  addRoot(
    treeNode(
      treeNode( length = 2,
        treeLeaf("Okinawa", 1),
        treeLeaf("Kume", 1)
      ),
      treeNode( length = 1,
        treeNode( length = 1,
          treeLeaf("Osaka", 1),
          treeLeaf("Aomori", 1)
        ),
        treeNode( length =1,
          treeLeaf("Norway", 1),
          treeLeaf("Barcelona", 1)
        )
      )
    )
  )

plot(ade4::newick2phylog(tree))
```

## Genome plots with genoPlotR

### Pairs of chromosome 1s.

```{r Oki_Bar_chr1, cache=TRUE, fig.width=15}
plotApairOfChrs(coa$Oki_Bar, "chr1", main = "Oki vs Bar")
```
```{r Oki_Osa_chr1, cache=TRUE, fig.width=15}
plotApairOfChrs(coa$Oki_Osa, "chr1", main = "Oki vs Osa")
```
```{r Osa_Oki_chr1, cache=TRUE, fig.width=15}
plotApairOfChrs(coa$Osa_Oki, "Chr1", main = "Osa vs Oki")
```
```{r Osa_Bar_chr1, cache=TRUE, fig.width=15}
plotApairOfChrs(coa$Osa_Bar, "Chr1", main = "Osa vs Bar")
```
```{r Oki_Bar_chr1_coa2, cache=TRUE, fig.width=15}
plotApairOfChrs(coa2$Osa_Bar, "Chr1", main = "Osa vs Bar (double-collapsed")
```

Kume's `chr1` is mostly comprised of 4 large contigs.

```{r coa_based, fig.width=15}
x <- coa$Oki_Kum
x[seqnames(x$query) == "contig_90_1"] <- reverse(query = TRUE, x[seqnames(x$query) == "contig_90_1"])
x[seqnames(x$query) == "contig_88_1"] <- reverse(query = TRUE, x[seqnames(x$query) == "contig_88_1"])

x$query <- mergeSeqLevels(x$query, c("contig_27_1", "contig_90_1", "contig_3_1", "contig_88_1"), "new_scaffold")
plotApairOfChrs(x, "chr1", dna_seg_scale=TRUE, main = "Oki vs Kum")
```

```{r coa2_based2, fig.width=15}
x <- coa2$Oki_Kum
x[seqnames(x$query) == "contig_90_1"] <- reverse(query = TRUE, x[seqnames(x$query) == "contig_90_1"])
x[seqnames(x$query) == "contig_88_1"] <- reverse(query = TRUE, x[seqnames(x$query) == "contig_88_1"])

x$query <- mergeSeqLevels(x$query, c("contig_27_1", "contig_90_1", "contig_3_1", "contig_88_1"), "new_scaffold")
plotApairOfChrs(x, "chr1", dna_seg_scale=TRUE, main = "Oki vs Kum (double-collapsed")
```

## Plot chr1 in three species

```{r plot_intersect_GBs_with_tree, fig.width=15}
doubleSubset <- function(gb, a, b) {
  gb <- gb[seqnames(gb) == a]
  gb <- gb[seqnames(gb$query) == b]
  gb
}

dsList <-   list(
    OKI = doubleSubset(coa$Oki_Osa, "chr1", "Chr1") |> gr2dna_seg(),
    OSA = doubleSubset(coa$Osa_Bar, "Chr1", "Chr1") |> gr2dna_seg(),
    BAR = doubleSubset(coa$Bar_Osa, "Chr1", "Chr1") |> gr2dna_seg()
)

compList <- list(
    doubleSubset(coa$Oki_Osa, "chr1", "Chr1") |> gb2comp(),
    Osa_Bar = doubleSubset(coa$Osa_Bar, "Chr1", "Chr1") |> gb2comp()
  )

genoPlotR::plot_gene_map(dsList, compList, dna_seg_scale=TRUE, tree=ade4::newick2phylog(addRoot(treeNode("OKI", treeNode("OSA", "BAR")))),
                         main = "Chromosome 1 in three Oikopleura genome assemblies")
```

## Plot chr1 in four species (double-collapsed)

```{r plot_intersect_GBs_with_tree_with_Kume, fig.width=15}
KumChr1 <-coa2$Oki_Kum
KumChr1[seqnames(KumChr1$query) == "contig_90_1"] <- reverse(query = TRUE, KumChr1[seqnames(KumChr1$query) == "contig_90_1"])
KumChr1[seqnames(KumChr1$query) == "contig_88_1"] <- reverse(query = TRUE, KumChr1[seqnames(KumChr1$query) == "contig_88_1"])
KumChr1$query <- mergeSeqLevels(KumChr1$query, c("contig_27_1", "contig_90_1", "contig_3_1", "contig_88_1"), "Chr1")

dsList <- list(
    KUM = doubleSubset(KumChr1,     "chr1", "Chr1") |> gr2dna_seg(),
    OKI = doubleSubset(coa2$Oki_Osa, "chr1", "Chr1") |> gr2dna_seg(),
    OSA = doubleSubset(coa2$Osa_Bar, "Chr1", "Chr1") |> gr2dna_seg(),
    BAR = doubleSubset(coa2$Bar_Osa, "Chr1", "Chr1") |> gr2dna_seg()
)

compList <- list(
    Oki_Kum = doubleSubset(KumChr1,     "chr1", "Chr1") |> gb2comp(),
    Oki_Osa = doubleSubset(coa2$Oki_Osa, "chr1", "Chr1") |> gb2comp(),
    Osa_Bar = doubleSubset(coa2$Osa_Bar, "Chr1", "Chr1") |> gb2comp()
  )

genoPlotR::plot_gene_map(dsList, compList, dna_seg_scale = TRUE,
                         tree = ade4::newick2phylog(addRoot(treeNode(treeNode("OKI", "KUM"), treeNode("OSA", "BAR")))),
                         main = "Chromosome 1 in four Oikopleura genome assemblies")
```

## Region that is conserved between Osaka and Barcelona

Since Okinawa is the outgroup, let's look for regions of it that are aligned
on both the Osaka and the Barcelona genomes.

```{r combine_GBs}
x <- subsetByOverlaps(coa2$Oki_Osa, granges(coa2$Oki_Bar)) |> subset(width > 1e5)
y <- subsetByOverlaps(coa2$Oki_Bar, granges(coa2$Oki_Osa)) |> subset(width > 1e5)
findOverlapPairs(x,y)
subsetByOverlaps(coa2$Oki_Osa, gaps(coa2$Oki_Bar)) |> subset(width > 1e5)

a <- coa$Oki_Osa |> subsetByOverlaps(GRanges("chr2:10000000-11000000")) |> doubleSubset("chr2", "Chr2")
b <- coa$Oki_Bar |> subsetByOverlaps(GRanges("chr2:10000000-11000000")) |> doubleSubset("chr2", "Chr2")
c <- coa$Bar_Osa |> subsetByOverlaps(range(b$query))                    |> doubleSubset("Chr2", "Chr2")

dsList <- list(
  OSA = swap(a) |> gr2dna_seg(),
  OKI = a |> gr2dna_seg(),
  BAR = swap(b) |> gr2dna_seg(),
  Osa = swap(c) |> gr2dna_seg()
)

compList <- list(
  a |> swap() |> gb2comp(),
  b |> gb2comp(),
  c |> gb2comp()
)

genoPlotR::plot_gene_map(dsList, compList, dna_seg_scale=TRUE)

```


# Session information

```{r sessionInfo}
sessionInfo()
```

