---
title: "Motif search and analysis"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Motif search and analysis}
  %\VignetteEncoding{UTF-8}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(cache = TRUE, include = FALSE)
knitr::opts_knit$set(verbose = TRUE)
```

# Introduction

Search for motifs in regions near genomic breaks.  By default the computations
that take time are loaded from R objects.  The source code to generate them
is only executed when the object files can not be found.

# Load pacakges

Core packages that provide functions we use a lot.

```{r loadlib}
library('OikScrambling')   |> suppressPackageStartupMessages()
genomes <- OikScrambling:::loadAllGenomes()
annots      <- OikScrambling:::loadAllAnnotations()   |> suppressWarnings()

load("BreakPoints.Rdata")

library('ggplot2')

requireNamespace("ggseqlogo")
requireNamespace("JASPAR2020") |> suppressPackageStartupMessages()
library("rGADEM") |> suppressPackageStartupMessages()
```

# Motif searches

[GADEM](https://www.niehs.nih.gov/research/resources/software/biostatistics/gadem/index.cfm)'s
documentation states:

> _The background sequences are simulated using the [a,c,g,t] frequencies in
> the input sequences, with length matched between the two sets. The background
> sequences are used as the random sequences for assessing motif enrichment in
> the input data._

```{r functions_for_motif_search}
# Note that GADEM crashes on sequences longer than ~48 kbp.
getGRseqs <- function (gr, max = 48000) { 
  bsgenome_name <- gr |> genome() |> unique()
  bsgenome_obj <- get(bsgenome_name)
  seqs <- BSgenome::getSeq(bsgenome_obj,  gr)
  metadata(seqs)$genome <- bsgenome_name
  seqs[width(seqs) < max]
}

# Slow !
doGadem <- function(seqs) {
  bsgenome_name <- metadata(seqs)$genome
  bsgenome_obj <- get(bsgenome_name)
  GADEM(seqs, verbose=1, genome=bsgenome_obj)
}

gadems <- SimpleList()
```


## Aligned non-coalesced regions

Aligned regions that do not coalesce into syntenic blocks are relatively
depleted in genes, and show no enrichment of exons versus introns.  They are
also depleted in repeats, and are mildly enriched in CNEs.  Altogether, they
can not be summarised in one feature.  So let's see if there are motifs enriched
there.

See `vignette("GenomicFeatuers", package = "OikScrambling")` for details on
these regions.

```{r search_in_aln_nonCoa}
alnNonCoa_seqs <- sapply(gbs[1:15], \(gb) gb[gb$nonCoa] |> getGRseqs()) |> SimpleList()
sapply(alnNonCoa_seqs, length)
if(!file.exists("gadems.alnNonCoa.Rds")) {
  gadems$alnNonCoa <- BiocParallel::bplapply(alnNonCoa_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$alnNonCoa, file = "gadems.alnNonCoa.Rds")
} else {
  gadems$alnNonCoa <- readRDS("gadems.alnNonCoa.Rds")
}
```

## Unmapped

There regions are not aligned and not within a synteny block.

```{r search_in_unmap}
unmap_seqs <- sapply(unmap[1:15], getGRseqs) |> SimpleList()
sapply(unmap_seqs, length)
if(!file.exists("gadems.unmap.Rds")) {
  gadems$unmap <- BiocParallel::bplapply(unmap_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$unmap, file = "gadems.unmap.Rds")
} else {
  gadems$unmap <- readRDS("gadems.unmap.Rds")
}
```

## Unaligned regions near inversions

I wanted to search search for motifs near inversions to see if they can
lead to an explanation.

See `vignette("Inversions", package = "OikScrambling")` for details on inversion.

### Isolate the left-side gaps in inversions

```{r search_in_gaps_near_inversions}
inv.lgaps <- sapply(coa, leftInversionGaps) |> SimpleList()
inv.lgaps_seqs <- sapply(inv.lgaps[1:15], getGRseqs) |> SimpleList()
sapply(inv.lgaps_seqs, length)
if(!file.exists("gadems.inv.lgaps.Rds")) {
  gadems$inv.lgaps <- BiocParallel::bplapply(inv.lgaps_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$inv.lgaps, file = "gadems.inv.lgaps.Rds")
} else {
  gadems$inv.lgaps <- readRDS("gadems.inv.lgaps.Rds")
}
```

## Inversions

```{r search_in_inversions}
inv_seqs <- sapply(coa[1:15], leftInversionGaps) |> sapply(getGRseqs) |> SimpleList()
sapply(inv_seqs, length)
if (!file.exists("gadems.invs.Rds")) {
  gadems$invs <- BiocParallel::bplapply(inv_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$inv, file = "gadems.invs.Rds")
} else {
  gadems$invs <- readRDS("gadems.invs.Rds")
}
```

## Promoters

```{r search_in_promoters}
prom_seqs <- sapply(annots[1:3], \(gb) suppressWarnings(trim(promoters(gb)))) |>
  sapply(getGRseqs) |> SimpleList()
sapply(prom_seqs, length)
if (!file.exists("gadems.proms.Rds")) {
  gadems$proms <- BiocParallel::bplapply(prom_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$proms, file = "gadems.proms.Rds")
} else {
  gadems$proms <- readRDS("gadems.proms.Rds")
}
```

## Introns

```{r search_in_introns}
intron_seqs <- sapply(annots[1:3], GenomicFeatures::intronicParts) |>
  sapply(getGRseqs) |> SimpleList()
sapply(intron_seqs, length)
if (!file.exists("gadems.introns.Rds")) {
  gadems$introns <- BiocParallel::bplapply(intron_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$introns, file = "gadems.introns.Rds")
} else {
  gadems$introns <- readRDS("gadems.introns.Rds")
}
```

## Summary

Number of motifs found

```{r summarise_gadems}
sapply(gadems, sapply, \(x) length(x@motifList))
```

# Display

Service functions.

```{r plot_all_motifs, fig.width=6}
showAllMotifs <- function(gadems) {
  sapply(names(gadems), \(name) {
    sapply(seq_along(gadems[[name]]@motifList), \(n) {
      gadems[[name]][[n]]@consensus
    })
  })
}

plotAllMotifs <- function(gadems) {
  for (curObjName in names(gadems)) {
    for (n in seq_along(gadems[[curObjName]]@motifList)) {
      p <- plotOneMotif(gadems[[curObjName]][[n]], curObjName)
      print(p)
    }
  }
}

plotOneMotif <- function(gadem, pairName = NULL, range = NULL) {
  if(is.null(range)) {
    pwm <- rGADEM::getPWM(gadem)
    consensus <- gadem@consensus
  } else {
    pwm <- rGADEM::getPWM(gadem)[,range]
    consensus <- gadem@consensus |> subseq(min(range), max(range))
  }
  title = paste0("Motif consensus: ", consensus)
  if(!is.null(pairName))
  title <- paste0("Genome pair: ", pairName, ", ", title)
  # Suppressed warning message: `guides(<scale> = FALSE)` is deprecated. Please use `guides(<scale> = "none")` instead. 
  p <- ggseqlogo::ggseqlogo(pwm) |> suppressWarnings()
  p  + ggtitle(title)
}
```

## Aligned non-coalesced regions

Many comparison return a motif that looks like `AAAA.....AAAA`, and some also
return `AAGAA` (or their reverse-complement).

The Oki - Kume comparison shows T-rich motifs (note that they could have been
A-rich reverse-complement).

Sometimes a weaker A-rich / T-rich motif is also found.

```{r show_alnNonCoa_motifs}
showAllMotifs(gadems$alnNonCoa)
```

Here are a few graphical examples.

```{r plot_some_alnNonCoa_motifs}
plotOneMotif(gadems$alnNonCoa$Oki_Osa[[1]], "Okinawa - Osaka")
plotOneMotif(gadems$alnNonCoa$Oki_Osa[[2]], "Okinawa - Osaka")
plotOneMotif(gadems$alnNonCoa$Oki_Kum[[1]], "Okinawa - Kume")
plotOneMotif(gadems$alnNonCoa$Oki_Kum[[2]], "Okinawa - Kume")
plotOneMotif(gadems$alnNonCoa$Osa_Oki[[2]], "Osaka - Okinawa")
plotOneMotif(gadems$alnNonCoa$Osa_Bar[[2]], "Osaka - Barcelona")
```

## Unaligned non-mapped regions

We still find `AAAA.....AAAA`,`AAGAA`, `A`-rich (or their reverse-complement),
but not as systematicaly.

We start to see species-specific motifs:

  - Variations over `GsCsCkwmGsGsC` in some Oki -> other comparisons.
  - Variations over `GCT..GCT` in some Nor -> other comparisons (pay attention
    the reverse complements).


```{r show_unal_motifs}
showAllMotifs(gadems$unmap)
```

Here are a few graphical examples.

```{r plot_some_unal_motifs}
plotOneMotif(gadems$unmap$Oki_Osa[[2]], "Okinawa - Osaka")
plotOneMotif(gadems$unmap$Oki_Kum[[1]], "Okinawa - Kume")
plotOneMotif(gadems$unmap$Osa_Oki[[1]], "Osaka - Okinawa")
plotOneMotif(gadems$unmap$Bar_Osa[[1]], "Barcelona - Okinawa")
```

## Unaligned regions left to inversion

  - We still find `AAAA.....AAAA`,`AAGAA`, `A`-rich (or their reverse-complement).
  - We see palindromic motifs (`CCTGA.TCAGG`, `aaGCCGc...gCGGCtt`) in the Okinawan genome.
  - Two other motifs are found when comparing Oki to Aom (`nGAGGCmACGmsCGTTCn`)
    and to Nor `nACGCyCryTCATTCTwTy`).
  - In the Osaka genome, we see a the `GCT..GCT` motif again.


```{r show_invLeft_motifs}
showAllMotifs(gadems$inv.lgaps)
```


Here are a few graphical examples.

### `CCTGA.TCAGG`

```{r plot_some_CCTGA.TCAGG_motifs_from_invs}
plotOneMotif(gadems$inv.lgaps$Oki_Osa[[1]], "Okinawa - Osaka")
plotOneMotif(gadems$inv.lgaps$Oki_Kum[[2]], "Okinawa - Kume")
```

### `aaGCCGc...gCGGCtt`

```{r plot_some_aaGCCGc...gCGGCtt_motifs_from_invs}
plotOneMotif(gadems$inv.lgaps$Oki_Osa[[3]], "Okinawa - Osaka")
plotOneMotif(gadems$inv.lgaps$Oki_Kum[[1]], "Okinawa - Kume")
```

### Other from Okinawan genome

```{r plot_some_more_motifs_from_invs}
plotOneMotif(gadems$inv.lgaps$Oki_Aom[[6]], "Okinawa - Aomori")
plotOneMotif(gadems$inv.lgaps$Oki_Nor[[4]], "Okinawa - Norway")
```

### `GCT..GCT`

```{r plot_GCT..GCT_motifs_from_invs}
plotOneMotif(gadems$inv.lgaps$Osa_Oki[[1]], "Osaka - Okinawa")
plotOneMotif(gadems$inv.lgaps$Osa_Bar[[1]], "Osaka - Barcelona")
```

### `GCTTCGCTTC`


```{r plot_GCTTCGCTTC_from_invs}
plotOneMotif(gadems$inv.lgaps$Osa_Kum[[1]], "Osaka - Kume")
plotOneMotif(gadems$inv.lgaps$Bar_Osa[[1]], "Barcelona - Okinawa")
```

### `CAA....TTGGTCA`

```{r plot_CAA....TTGGTCA_from_invs}
plotOneMotif(gadems$inv.lgaps$Osa_Kum[[5]], "Osaka - Kume")
plotOneMotif(gadems$inv.lgaps$Osa_Oki[[4]], "Osaka - Okinawa")
plotOneMotif(gadems$inv.lgaps$Osa_Nor[[2]], "Osaka - Norway")
```

# AT richness

Unmapped regions have a much higher AT-richness than aligned ones.

```{r at_richness}
## Inverted regions are AT-rich as usual.
invRegions <- sapply(coa[1:15], \(gr) filterInversions(flagInversions(gr))) |> SimpleList()
invSeq <-  sapply(invRegions, getGRseqs) |> SimpleList()

rbind(
  alnNonCoa = sapply(alnNonCoa_seqs, \(seq) letterFrequency(seq, "AT", as.prob = TRUE) |> mean()),
  unmap     = sapply(unmap_seqs, \(seq) letterFrequency(seq, "AT", as.prob = TRUE) |> mean()),
  inv.lgaps = sapply(inv.lgaps_seqs, \(seq) letterFrequency(seq, "AT", as.prob = TRUE) |> mean()),
  inv       = sapply(invSeq, \(seq) letterFrequency(seq, "AT", as.prob = TRUE) |> mean())
)

(genomes.AT <- sapply(genomes, \(g)
  weighted.mean(letterFrequency(getSeq(g), "AT", as.prob = TRUE), seqlengths(g))))

## This difference is significant.
t.test(letterFrequency(invSeq$Oki_Osa, "AT", as.prob = TRUE), letterFrequency(inv.lgaps_seqs$Oki_Osa, "AT", as.prob = TRUE))
t.test(letterFrequency(invSeq$Osa_Oki, "AT", as.prob = TRUE), letterFrequency(inv.lgaps_seqs$Osa_Oki, "AT", as.prob = TRUE))
t.test(letterFrequency(invSeq$Oki_Bar, "AT", as.prob = TRUE), letterFrequency(inv.lgaps_seqs$Oki_Bar, "AT", as.prob = TRUE))
t.test(letterFrequency(invSeq$Oki_Kum, "AT", as.prob = TRUE), letterFrequency(inv.lgaps_seqs$Oki_Kum, "AT", as.prob = TRUE))
```


A palindromic (rAAGCsGCwwmkCGrCTTyn) motif is found in the left gaps.

Or could it be `GCCGCnnnGCGGC` ?  Its frequency in genomes is something like:
```
  Oki   Osa   Bar   Kum   Aom   Nor 
10827  2273  1967 10880  2210  2247 
```

On the other hand, a motif containing GCGAAGCGAA identified in Osa_Oki shows:

```
  Oki   Osa   Bar   Kum   Aom   Nor 
  483 21360 23340   501 21594 16413 
```

# Search for the motifs in JASPAR

```{r screenJaspar}
checkJaspar <- function (pwm, range=NULL) {
  if(is.null(range))
    PWMat <- TFBSTools::PWMatrix(ID=pwm@consensus, profileMatrix = pwm@pwm)
  else
    PWMat <- TFBSTools::PWMatrix(ID = subseq(pwm@consensus, min(range), max(range)),
                                 profileMatrix = pwm@pwm[,range])
  #---- see https://compgenomr.github.io/book/motif-discovery.html
  pwmLib <- TFBSTools::getMatrixSet(
    JASPAR2020::JASPAR2020,
    opts = list(
      collection = 'CORE',
   #   species    = 'Homo sapiens',
      matrixtype = 'PWM'))
  
  pwm_sim <- TFBSTools::PWMSimilarity( pwmLib, PWMat,  method = 'Pearson')

  pwmLibDf <- data.frame(
    ID        = sapply(pwmLib, TFBSTools::ID),
    name      = sapply(pwmLib, TFBSTools::name),
    row.names = seq_along(pwmLib)
  )
  pwmLibDf$similarity <- pwm_sim[pwmLibDf$ID]
  pwmLibDf[order(-pwmLibDf$similarity),]
}

gadems$inv.lgaps$Oki_Osa[[1]] |> checkJaspar() |> head()
gadems$inv.lgaps$Oki_Kum[[1]] |> checkJaspar() |> head()

# Let's trim the motif.
gadems$inv.lgaps$Oki_Kum[[1]] |> plotOneMotif(range = 2:9)
gadems$inv.lgaps$Oki_Osa[[1]] |> checkJaspar(range = 2:9) |> head()
```

But a search in Jaspar with either the full motif or its halof did not reveal
strong hits.  Visual inspection of PRDM9 sequence logos via Google did not show
similarity either.


```
# writeXStringSet(lgapsSeq_Oki_O, file="firstGaps.fasta")
# I used this FASTA export to search for motifs with GLAM2, and it also
# returned A/T polymers.
```

The GLAM2 motif finder was run on this file, and then to screen the genome.
Hits coordinates were encoded in a BED file uploaded to the ZENBU genome browser.
Visual inspection gave me the impression that the motif might be related to
repeats.

GLAM2 search of the gap sequences did not return a motif similar to "AAGCsGCwwmkCGrCTTyn".

### Whole-genome search of the motif

Disappointingly, the motif is found equally in gaps and inversions when searched
with its PWM.

```{r PWM_score_on_chrs, warning=FALSE}
# No exact match
vmatchPattern("rAAGCsGCwwmkCGrCTTyn", OKI2018_I69)

pwm <- rGADEM::getPWM(gadems$inv.lgaps$Oki_Osa[[1]])

pwmHits <- sapply(genomes, matchPWM, pwm = pwm)
sapply(pwmHits, length)
hist(pwmHits$Oki$score)
hist(pwmHits$Osa$score)

pwmHit <- pwmHits$Oki

library("Gviz")
options(ucscChromosomeNames=FALSE)
gen <- GenomeAxisTrack(name = "genome")
a <- AnnotationTrack(longShort$Oki, chromosome = "chr1")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "chr1")
plotTracks(list(gen, a, trk))
a <- AnnotationTrack(longShort$Oki, chromosome = "chr2")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "chr2")
plotTracks(list(gen, a, trk))
a <- AnnotationTrack(longShort$Oki, chromosome = "PAR")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "PAR")
plotTracks(list(gen, a, trk))
a <- AnnotationTrack(longShort$Oki, chromosome = "XSR")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "XSR")
plotTracks(list(gen, a, trk))
```

```{r}

length(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa))
length(subsetByOverlaps(pwmHits$Oki, invRegions$Oki_Osa))

hist(score(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa)))
hist(score(subsetByOverlaps(pwmHits$Oki, invRegions$Oki_Osa)))

# Scores in gaps are higher than average.
t.test(score(pwmHits$Oki), score(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa)))

# Scores in gaps and inversions are not different 
t.test(score(subsetByOverlaps(pwmHits$Oki, invRegions$Oki_Osa)), score(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa)))

# rtracklayer::export.bed(pwmHits, "AAGCsGCwwmkCGrCTTyn.bed")

# PWM hits seem to be more abundant on short arms.
#OKI_longShort$pwmHitsPerMb <- countOverlaps(OKI_longShort, pwmHits$Oki) / width(OKI_longShort) * 1e6
# But with a naive approach the difference is not statistically significant.
t.test(c(159, 185, 188), c(77, 142, 160))
```
