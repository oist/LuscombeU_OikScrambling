---
title: "Motif search and analysis"
author: 
 - "Charles Plessy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Motif search and analysis}
  %\VignetteEncoding{UTF-8}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(cache = TRUE, include = FALSE)
knitr::opts_knit$set(verbose = TRUE)
```

# Introduction

Search for motifs in regions near genomic breaks.  By default the computations
that take time are loaded from R objects.  The source code to generate them
is only executed when the object files can not be found.

# Load pacakges

Core packages that provide functions we use a lot.

```{r loadlib}
library('OikScrambling')   |> suppressPackageStartupMessages()
genomes <- OikScrambling:::loadAllGenomes()
transcripts <- OikScrambling:::loadAllTranscriptsGR() |> suppressWarnings()
load("BreakPoints.Rdata")

library('ggplot2')

requireNamespace("ggseqlogo")
requireNamespace("JASPAR2020") |> suppressPackageStartupMessages()
library("rGADEM") |> suppressPackageStartupMessages()
```

# Motif searches

```{r functions_for_motif_search}
# Note that GADEM crashes on sequences longer than ~48 kbp.
getGRseqs <- function (gr, max = 48000) { 
  bsgenome_name <- gr |> genome() |> unique()
  bsgenome_obj <- get(bsgenome_name)
  seqs <- BSgenome::getSeq(bsgenome_obj,  gr)
  metadata(seqs)$genome <- bsgenome_name
  seqs[width(seqs) < max]
}

# Slow !
doGadem <- function(seqs) {
  bsgenome_name <- metadata(seqs)$genome
  bsgenome_obj <- get(bsgenome_name)
  GADEM(seqs, verbose=1, genome=bsgenome_obj)
}

gadems <- SimpleList()
```


## Aligned non-coalesced regions

Aligned regions that do not coalesce into syntenic blocks are relatively
depleted in genes, and show no enrichment of exons versus introns.  They are
also depleted in repeats, and are mildly enriched in CNEs.  Altogether, they
can not be summarised in one feature.  So let's see if there are motifs enriched
there.

See `vignette("GenomicFeatuers", package = "OikScrambling")` for details on
these regions.

```{r search_in_aln_nonCoa}
alnNonCoa_seqs <- sapply(gbs[1:15], \(gb) gb[gb$nonCoa] |> getGRseqs()) |> SimpleList()
if(!file.exists("gadems.alnNonCoa.Rds")) {
  gadems$alnNonCoa <- BiocParallel::bplapply(alnNonCoa_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$alnNonCoa, file = "gadems.alnNonCoa.Rds")
} else {
  gadems$alnNonCoa <- readRDS("gadems.alnNonCoa.Rds")
}
```

## Unmapped

There regions are not aligned and not within a synteny block.

```{r search_in_unmap}
unmap_seqs <- sapply(unmap[1:15], getGRseqs) |> SimpleList()
if(!file.exists("gadems.unmap.Rds")) {
  gadems$unmap <- BiocParallel::bplapply(unmap_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$unmap, file = "gadems.unmap.Rds")
} else {
  gadems$unmap <- readRDS("gadems.unmap.Rds")
}
```

## Inversions

I wanted to search search for motifs near inversions to see if they can
lead to an explanation.

See `vignette("Inversions", package = "OikScrambling")` for details on inversion.

### Isolate the left-side gaps in inversions

```{r search_for_inversions}
inv.lgaps <- sapply(coa, leftInversionGaps) |> SimpleList()

inv.lgaps_seqs <- sapply(inv.lgaps[1:15], getGRseqs) |> SimpleList()
if(!file.exists("gadems.inv.lgaps.Rds")) {
  gadems$inv.lgaps <- BiocParallel::bplapply(inv.lgaps_seqs, doGadem) |> SimpleList()
  saveRDS(gadems$inv.lgaps, file = "gadems.inv.lgaps.Rds")
} else {
  gadems$inv.lgaps <- readRDS("gadems.inv.lgaps.Rds")
}
```

## Summary

Number of motifs found

```{r summarise_gadems}
sapply(gadems, sapply, \(x) length(x@motifList))
```

# Display

Service functions.

```{r plot_all_motifs, fig.width=6}
showAllMotifs <- function(gadems) {
  sapply(names(gadems), \(name) {
    sapply(seq_along(gadems[[name]]@motifList), \(n) {
      gadems[[name]][[n]]@consensus
    })
  })
}

plotAllMotifs <- function(gadems) {
  for (curObjName in names(gadems)) {
    for (n in seq_along(gadems[[curObjName]]@motifList)) {
      p <- plotOneMotif(gadems[[curObjName]][[n]], curObjName)
      print(p)
    }
  }
}

plotOneMotif <- function(gadem, pairName = NULL) {
  pwm <- rGADEM::getPWM(gadem)
  title = paste0("Motif consensus: ", gadem@consensus)
  if(!is.null(pairName))
  title <- paste0("Genome pair: ", pairName, ", ", title)
  # Suppressed warning message: `guides(<scale> = FALSE)` is deprecated. Please use `guides(<scale> = "none")` instead. 
  p <- ggseqlogo::ggseqlogo(pwm) |> suppressWarnings()
  p  + ggtitle(title)
}
```

## Aligned non-coalesced regions

Many comparison return a motif that looks like `AAAA.....AAAA`, and some also
return `AAGAA` (or their reverse-complement).

The Oki - Kume comparison shows T-rich motifs (note that they could have been
A-rich reverse-complement).

Sometimes a weaker A-rich / T-rich motif is also found.

```{r show_alnNonCoa_motifs}
showAllMotifs(gadems$alnNonCoa)
```

Here are a few graphical examples.

```{r plot_some_alnNonCoa_motifs}
plotOneMotif(gadems$alnNonCoa$Oki_Osa[[1]], "Okinawa - Osaka")
plotOneMotif(gadems$alnNonCoa$Oki_Osa[[2]], "Okinawa - Osaka")
plotOneMotif(gadems$alnNonCoa$Oki_Kum[[1]], "Okinawa - Kume")
plotOneMotif(gadems$alnNonCoa$Oki_Kum[[2]], "Okinawa - Kume")
plotOneMotif(gadems$alnNonCoa$Osa_Oki[[2]], "Osaka - Okinawa")
plotOneMotif(gadems$alnNonCoa$Osa_Bar[[2]], "Osaka - Barcelona")
```

## Unaligned non-mapped regions

We still find `AAAA.....AAAA`,`AAGAA`, `A`-rich (or their reverse-complement),
but not as systematicaly.

We start to see species-specific motifs:

  - Variations over `GsCsCkwmGsGsC` in some Oki -> other comparisons.
  - Variations over `GCT..GCT` in some Nor -> other comparisons (pay attention
    the reverse complements).


```{r show_alnNonCoa_motifs}
showAllMotifs(gadems$unmap)
```

Here are a few graphical examples.

```{r plot_some_alnNonCoa_motifs}
plotOneMotif(gadems$unmap$Oki_Osa[[2]], "Okinawa - Osaka")
plotOneMotif(gadems$unmap$Oki_Kum[[1]], "Okinawa - Kume")
plotOneMotif(gadems$unmap$Osa_Oki[[1]], "Osaka - Okinawa")
plotOneMotif(gadems$unmap$Bar_Osa[[1]], "Barcelona - Okinawa")
```

## Inversion left gaps


Here are a few graphical examples.

```{r plot_some_alnNonCoa_motifs}
plotOneMotif(gadems$inv.lgaps$Oki_Osa[[1]], "Okinawa - Osaka")
plotOneMotif(gadems$unmap$Oki_Kum[[1]], "Okinawa - Kume")
plotOneMotif(gadems$unmap$Osa_Oki[[1]], "Osaka - Okinawa")
plotOneMotif(gadems$unmap$Bar_Osa[[1]], "Barcelona - Okinawa")
```
### AT richness

```{r at_richness}
## Inverted regions are AT-rich as usual.
invRegions <- sapply(coa[1:15], \(gr) filterInversions(flagInversions(gr))) |> SimpleList()
invSeq <-  sapply(invRegions, getGRseqs) |> SimpleList()

sapply(invSeq, \(seq) letterFrequency(seq, "AT", as.prob = TRUE) |> summary())
(genomes.AT <- sapply(genomes, \(g)
  weighted.mean(letterFrequency(getSeq(g), "AT", as.prob = TRUE), seqlengths(g))))

## But gaps are a bit more AT-rich.
sapply(inv.lgaps.Seq, \(seq) letterFrequency(seq, "AT", as.prob = TRUE) |> summary())

## This difference is significant.
t.test(letterFrequency(invSeq$Oki_Osa, "AT", as.prob = TRUE), letterFrequency(inv.lgaps.Seq$Oki_Osa, "AT", as.prob = TRUE))
t.test(letterFrequency(invSeq$Osa_Oki, "AT", as.prob = TRUE), letterFrequency(inv.lgaps.Seq$Osa_Oki, "AT", as.prob = TRUE))
t.test(letterFrequency(invSeq$Oki_Bar, "AT", as.prob = TRUE), letterFrequency(inv.lgaps.Seq$Oki_Bar, "AT", as.prob = TRUE))
t.test(letterFrequency(invSeq$Oki_Kum, "AT", as.prob = TRUE), letterFrequency(inv.lgaps.Seq$Oki_Kum, "AT", as.prob = TRUE))
```

I was tempted to explain this difference with A/T homopolymer stetches.  But
de novo motif prediction with rGADEM finds AT-rich motifs in any set of Oik
sequences that I have tried.


```{r}

#RGadem positive control: check introns ?
# set.seed(1664)
# intr <- sample(intronicParts(tx_OKI), 1000)
# intr <- BSgenome::getSeq(OKI2018_I69, intr)
# gadem <- GADEM(intr, verbose=1, genome=OKI2018_I69)
# > consensus(gadem)
# [1] "nAAAAwnnwnAAAwn"
# Also found motifs like rryCAATTbwTkCGmAkyT


#RGadem positive control: check promoters ?
# set.seed(1664)
# prom <- sample(promoters(tx_OKI), 1000)
# prom <- BSgenome::getSeq(OKI2018_I69, prom)
# gadem <- GADEM(prom, verbose=1, genome=OKI2018_I69)
# consensus(gadem)
# [1] "nAAAAwwnwnnAAAAwn" "nTTTTCTTyn"       
# Also found motifs like TTTmAAAA
```

A palindromic (rAAGCsGCwwmkCGrCTTyn) motif is found in the left gaps.

Or could it be `GCCGCnnnGCGGC` ?  Its frequency in genomes is something like:
```
  Oki   Osa   Bar   Kum   Aom   Nor 
10827  2273  1967 10880  2210  2247 
```

On the other hand, a motif containing GCGAAGCGAA identified in Osa_Oki shows:

```
  Oki   Osa   Bar   Kum   Aom   Nor 
  483 21360 23340   501 21594 16413 
```
  
```{r screenJaspar}
checkJaspar <- function (pwm) {
  #---- see https://compgenomr.github.io/book/motif-discovery.html
  pwmLib <- TFBSTools::getMatrixSet(
    JASPAR2020::JASPAR2020,
    opts = list(
      collection = 'CORE',
   #   species    = 'Homo sapiens',
      matrixtype = 'PWM'))
  
  pwm_sim <- TFBSTools::PWMSimilarity( pwmLib, PWMat,  method = 'Pearson')

  pwmLibDf <- data.frame(
    ID        = sapply(pwmLib, TFBSTools::ID),
    name      = sapply(pwmLib, TFBSTools::name),
    row.names = seq_along(pwmLib)
  )
  pwmLibDf$similarity <- pwm_sim[pwmLibDf$ID]
  pwmLibDf[order(-pwmLibDf$similarity),]
}

PWMat <- TFBSTools::PWMatrix(ID="rAAGCsGCwwmkCGrCTTyn", profileMatrix = pwm)
pwm_res <- checkJaspar(PWMat)
head(pwm_res)

pwmhalf <- pwm[,2:8]
pwmhalf_res <- checkJaspar(PWMatrix(ID="AAGCnGC", profileMatrix = pwmhalf))
head(pwmhalf_res)
```

But a search in Jaspar with either the full motif or its halof did not reveal
strong hits.  Visual inspection of PRDM9 sequence logos via Google did not show
similarity either.

### Export rAAGCsGCwwmkCGrCTTyn alignments to a file

```{r pwmHitSequenceExportForGLAM2}
# gademHitsToBS <- function(gadem, n) {
#   alignList <- gadem[[n]]@alignList
#   pwmSeqs <- sapply(alignList, function(align) align@seq)
#   Biostrings::DNAStringSet(pwmSeqs)
# }
# 
# pwmSeqs <- gademHitsToBS(gadem, 1)
# writeXStringSet(pwmBS, file="firstGapsGADEMpwm.fasta")
```

```
# writeXStringSet(lgapsSeq_Oki_O, file="firstGaps.fasta")
# I used this FASTA export to search for motifs with GLAM2, and it also
# returned A/T polymers.
```

The GLAM2 motif finder was run on this file, and then to screen the genome.
Hits coordinates were encoded in a BED file uploaded to the ZENBU genome browser.
Visual inspection gave me the impression that the motif might be related to
repeats.

GLAM2 search of the gap sequences did not return a motif similar to "AAGCsGCwwmkCGrCTTyn".

### Whole-genome search of the motif

Disappointingly, the motif is found equally in gaps and inversions when searched
with its PWM.

```{r PWM_score_on_chrs, warning=FALSE}
# No exact match
vmatchPattern("rAAGCsGCwwmkCGrCTTyn", OKI2018_I69)

pwm <- rGADEM::getPWM(gadems.invLeftGap$Oki_Osa[[1]])
gadems.invLeftGap$Oki_Osa[[1]]@consensus

pwmHits <- sapply(genomes, matchPWM, pwm = pwm)
sapply(pwmHits, length)
hist(pwmHits$Oki$score)
hist(pwmHits$Osa$score)

pwmHit <- pwmHits$Oki

library("Gviz")
options(ucscChromosomeNames=FALSE)
gen <- GenomeAxisTrack(name = "genome")
a <- AnnotationTrack(longShort$Oki, chromosome = "chr1")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "chr1")
plotTracks(list(gen, a, trk))
a <- AnnotationTrack(longShort$Oki, chromosome = "chr2")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "chr2")
plotTracks(list(gen, a, trk))
a <- AnnotationTrack(longShort$Oki, chromosome = "PAR")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "PAR")
plotTracks(list(gen, a, trk))
a <- AnnotationTrack(longShort$Oki, chromosome = "XSR")
trk <- DataTrack(pwmHit |> (\(.){strand(.)<-"*";.})(), name = "pwmHits", chromosome = "XSR")
plotTracks(list(gen, a, trk))
```

```{r}

length(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa))
length(subsetByOverlaps(pwmHits$Oki, invRegions$Oki_Osa))

hist(score(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa)))
hist(score(subsetByOverlaps(pwmHits$Oki, invRegions$Oki_Osa)))

# Scores in gaps are higher than average.
t.test(score(pwmHits$Oki), score(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa)))

# Scores in gaps and inversions are not different 
t.test(score(subsetByOverlaps(pwmHits$Oki, invRegions$Oki_Osa)), score(subsetByOverlaps(pwmHits$Oki, inv.lgaps$Oki_Osa)))

# rtracklayer::export.bed(pwmHits, "AAGCsGCwwmkCGrCTTyn.bed")

# PWM hits seem to be more abundant on short arms.
#OKI_longShort$pwmHitsPerMb <- countOverlaps(OKI_longShort, pwmHits$Oki) / width(OKI_longShort) * 1e6
# But with a naive approach the difference is not statistically significant.
t.test(c(159, 185, 188), c(77, 142, 160))
```
